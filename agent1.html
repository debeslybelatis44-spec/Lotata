<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LOTATO PRO | Agent System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ad00f1;
            --secondary: #00d4ff;
            --accent: #ff007a;
            --bg: #0a0b1e;
            --surface: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(81, 6, 75, 0.699);
            --text-main: #ffffff;
            --text-dim: #a0a0b8;
            --success: #00f190;
            --danger: #ff4d4d;
            --warning: #ffa502;
            --miami: #ff4757;
            --newyork: #ffa502;
            --georgia: #2ed573;
            --texas: #ff6b35;
            --tunisia: #00cec9;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            background: radial-gradient(circle at top right, #1a1b3a, #0a0b1e);
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes pulseActive { 0% { box-shadow: 0 0 0 0 rgba(173, 0, 241, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(173, 0, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(173, 0, 241, 0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 60%, 100% { transform: translateY(0); } 40% { transform: translateY(-5px); } 80% { transform: translateY(-2px); } }

        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        .pulse-active { animation: pulseActive 1.5s infinite; }
        .animate-bounce { animation: bounce 0.5s; }

        /* Layout Global */
        .app-shell {
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            padding: 20px;
            backdrop-filter: blur(15px);
            position: sticky;
            top: 0; z-index: 1000;
            display: flex; justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .brand h1 {
            font-size: 1.5rem;
        }

        .pro-badge {
            background: var(--primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        /* Tirages */
        .draw-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 20px;
        }

        .draw-card {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .draw-card.active {
            background: rgba(173, 0, 241, 0.1);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(173, 0, 241, 0.2);
        }

        .draw-card.blocked {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .draw-card.blocked::after {
            content: "BLOKÉ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Betting Panel */
        .betting-panel {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: 32px 32px 0 0;
            padding: 25px 20px;
            border-top: 1px solid var(--glass-border);
            margin-top: auto;
        }

        .game-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .game-selector::-webkit-scrollbar {
            height: 3px;
        }

        .chip {
            padding: 8px 14px;
            border-radius: 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(173, 0, 241, 0.3);
        }

        .chip.numeric-chip {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .chip.numeric-chip.active {
            background: var(--secondary);
            color: black;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .chip.special-chip {
            background: rgba(255, 0, 122, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .chip.special-chip.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 15px rgba(255, 0, 122, 0.5);
        }

        .chip.auto-chip {
            background: rgba(0, 241, 144, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .chip.auto-chip.active {
            background: var(--success);
            color: black;
            box-shadow: 0 0 15px rgba(0, 241, 144, 0.5);
        }

        .chip.lotto-chip {
            background: rgba(255, 165, 2, 0.1);
            border-color: #ffa502;
            color: #ffa502;
        }

        .chip.lotto-chip.active {
            background: #ffa502;
            color: black;
            box-shadow: 0 0 15px rgba(255, 165, 2, 0.5);
        }

        .input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        input {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 16px;
            color: white;
            font-size: 1.1rem;
            width: 100%;
            outline: none;
            transition: 0.2s;
            text-align: center;
        }

        input:focus { border-color: var(--secondary); background: rgba(0,0,0,0.4); }

        .btn-primary-gradient {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            min-width: 60px;
        }

        /* Cart */
        .cart-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 400px);
            min-height: 300px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cart-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .cart-total {
            background: rgba(173, 0, 241, 0.1);
            padding: 10px 15px;
            border-radius: 12px;
            font-weight: bold;
            border: 1px solid var(--primary);
        }

        .print-btn {
            background: var(--success);
            border: none;
            border-radius: 12px;
            color: black;
            font-weight: bold;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .print-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 241, 144, 0.5);
        }

        .cart-list {
            flex: 1;
            overflow-y: auto;
            margin: 15px 0;
        }

        .cart-item {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--primary);
            animation: fadeIn 0.3s ease;
        }

        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 11, 30, 0.95);
            backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding: 15px 10px 25px 10px;
            border-top: 1px solid var(--glass-border);
            z-index: 1000;
        }

        .nav-item {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.75rem;
            text-align: center;
            flex: 1;
            transition: color 0.3s;
        }

        .nav-item.active { 
            color: var(--secondary); 
            transform: translateY(-5px);
        }
        .nav-item.active i { 
            text-shadow: 0 0 10px var(--secondary);
        }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; transition: all 0.3s; }

        /* Historique */
        .history-screen {
            padding: 20px;
        }
        .history-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
        .history-card {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px;
        }
        .card-header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px; margin-bottom: 10px; font-size: 0.8rem; color: var(--text-dim); }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .btn-small { background: rgba(255,255,255,0.1); border: none; color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-wait { background: #555; color: white; }
        .badge-win { background: var(--success); color: black; box-shadow: 0 0 10px var(--success); }
        .badge-lost { background: rgba(255,0,0,0.2); color: #ff4d4d; }

        /* Rapports */
        .reports-screen {
            padding: 20px;
        }
        .report-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
        }
        .report-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 1rem;
        }
        .report-row.total {
            font-weight: 800;
            font-size: 1.2rem;
            border-top: 2px solid var(--glass-border);
            margin-top: 10px;
        }
        .val { font-family: 'Courier New', monospace; font-weight: bold; }

        /* Sync Bar */
        .sync-idle {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
        }

        /* Screen States */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }

        /* Multi-draw selection */
        .multi-draw-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
        }

        .multi-draw-checkbox {
            display: none;
        }

        .multi-draw-label {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .multi-draw-checkbox:checked + .multi-draw-label {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 10px rgba(173, 0, 241, 0.5);
        }

        .multi-draw-toggle {
            padding: 8px 16px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid var(--secondary);
            border-radius: 12px;
            color: var(--secondary);
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        /* Ticket summary */
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin: 10px 0;
            font-size: 1.2rem;
        }

        .btn-success-full {
            background: var(--success);
            border: none;
            border-radius: 16px;
            color: black;
            font-weight: bold;
            padding: 16px;
            width: 100%;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .multi-draw-indicator {
            background: rgba(0,212,255,0.1);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin: 10px 20px;
        }

        .empty-msg {
            text-align: center;
            color: var(--text-dim);
            padding: 20px;
        }

        /* Back button */
        .back-button {
            background: none;
            border: none;
            color: var(--secondary);
            font-size: 1.2rem;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Numeric chips container */
        .numeric-chips-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            animation: slideDown 0.3s ease-out;
        }

        .numeric-chips-container.visible {
            display: flex;
        }

        /* Lotto 4/5 options */
        .lotto-options {
            display: none;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            flex-wrap: wrap;
        }

        .lotto-options.visible {
            display: flex;
        }

        .option-chip {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .option-chip.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--secondary);
            color: var(--secondary);
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .option-chip input {
            display: none;
        }

        /* Game group containers */
        .special-games-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            animation: slideDown 0.3s ease-out;
        }

        .special-games-container.visible {
            display: flex;
        }

        .lotto-games-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            animation: slideDown 0.3s ease-out;
        }

        .lotto-games-container.visible {
            display: flex;
        }

        /* Toggle buttons */
        .toggle-btn {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--secondary);
            border-radius: 12px;
            color: var(--secondary);
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-btn.active {
            background: var(--secondary);
            color: black;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .sub-game-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .sub-game-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Warning message */
        .warning-message {
            background: rgba(255, 165, 2, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 10px 15px;
            border-radius: 12px;
            margin: 10px 20px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 10px;
        }

        /* Modal Winner */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .winner-modal {
            background: var(--bg);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            border: 2px solid var(--success);
        }

        .trophy-icon {
            font-size: 4rem;
            color: gold;
            margin-bottom: 20px;
        }

        .btn-close {
            background: var(--primary);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 12px;
            margin-top: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <div id="sync-status-bar" class="sync-idle">
            <span id="sync-text">Vérification des résultats...</span>
        </div>

        <header>
            <div class="brand">
                <h1 class="logo-text" id="lottery-name">LOTATO PRO <span class="pro-badge">v6</span></h1>
                <div id="live-clock">00:00:00</div>
            </div>
            <div class="user-profile">
                <i class="fas fa-user-circle"></i>
                <span id="agent-name">...</span>
                <button class="logout-btn" onclick="logout()" title="Dekonekte">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <main class="content-area">
            <!-- Screen 1: Draw Selection -->
            <section id="draw-selection-screen" class="screen active">
                <button class="back-button" onclick="goBackToDraws()" style="display:none;">
                    <i class="fas fa-arrow-left"></i> Retounen
                </button>
                <h2 class="section-title">Chwazi Tiraj</h2>
                
                <div style="padding: 0 20px 10px 20px;">
                    <button id="multi-draw-btn" class="multi-draw-toggle" onclick="toggleMultiDrawMode()">
                        <i class="fas fa-layer-group"></i> Plizyè Tiraj
                    </button>
                </div>

                <div id="multi-draw-container" class="multi-draw-selector" style="display: none;">
                    <!-- Multi-draw checkboxes will be inserted here -->
                </div>

                <div class="draw-grid" id="draws-container">
                    <!-- Draw cards will be inserted here -->
                </div>

                <div id="multi-draw-continue" style="display: none; padding: 20px;">
                    <button onclick="continueToBettingWithMultiDraw()" class="btn-success-full">
                        <i class="fas fa-play"></i> Kontinye ak Tiraj Chwazi yo
                    </button>
                </div>
            </section>

            <!-- Screen 2: Betting Interface -->
            <section id="betting-screen" class="screen">
                <button class="back-button" onclick="goBackToDraws()">
                    <i class="fas fa-arrow-left"></i> Retounen
                </button>
                <h2 class="section-title" id="current-draw-title">Miami Matin</h2>
                
                <div id="draw-blocked-warning" class="warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute plis paray.</span>
                </div>

                <!-- Multi-draw indicator -->
                <div id="multi-draw-indicator" class="multi-draw-indicator" style="display: none;">
                    <i class="fas fa-layer-group"></i> Jwe pou plizyè tiraj: <span id="selected-draws-count">1</span> tiraj
                </div>

                <!-- Lotto 4 Options -->
                <div id="lotto4-options" class="lotto-options">
                    <div class="option-chip active" data-option="1" onclick="toggleLottoOption(4, 1)">
                        <input type="checkbox" id="opt1-4" checked>
                        <label for="opt1-4">1e Opsyon (2e & 3e)</label>
                    </div>
                    <div class="option-chip active" data-option="2" onclick="toggleLottoOption(4, 2)">
                        <input type="checkbox" id="opt2-4" checked>
                        <label for="opt2-4">2e Opsyon (1e & 2e)</label>
                    </div>
                    <div class="option-chip active" data-option="3" onclick="toggleLottoOption(4, 3)">
                        <input type="checkbox" id="opt3-4" checked>
                        <label for="opt3-4">3e Opsyon (1e & 3e)</label>
                    </div>
                </div>

                <!-- Lotto 5 Options -->
                <div id="lotto5-options" class="lotto-options">
                    <div class="option-chip active" data-option="1" onclick="toggleLottoOption(5, 1)">
                        <input type="checkbox" id="opt1-5" checked>
                        <label for="opt1-5">1e Opsyon (1e lot & 2e lot)</label>
                    </div>
                    <div class="option-chip active" data-option="2" onclick="toggleLottoOption(5, 2)">
                        <input type="checkbox" id="opt2-5" checked>
                        <label for="opt2-5">2e Opsyon (1e lot & 3e lot)</label>
                    </div>
                    <div class="option-chip active" data-option="3" onclick="toggleLottoOption(5, 3)">
                        <input type="checkbox" id="opt3-5" checked>
                        <label for="opt3-5">3e Opsyon (1e lot & 1e lot)</label>
                    </div>
                </div>

                <section class="betting-panel animate-fade">
                    <div class="game-selector" id="game-types">
                        <button class="chip active" data-game="borlette">Borlette</button>
                        <button class="chip" data-game="lotto">Lotto</button>
                        <button class="chip" data-game="special">Jeux Spéciaux</button>
                        <button class="chip" id="toggle-nx-btn" onclick="toggleNumericChips()">NX</button>
                    </div>

                    <!-- Numeric chips for N0-N9 (hidden by default) -->
                    <div class="numeric-chips-container" id="numeric-chips">
                        <button class="chip numeric-chip" data-game="n0" onclick="selectGame('n0')">N0</button>
                        <button class="chip numeric-chip" data-game="n1" onclick="selectGame('n1')">N1</button>
                        <button class="chip numeric-chip" data-game="n2" onclick="selectGame('n2')">N2</button>
                        <button class="chip numeric-chip" data-game="n3" onclick="selectGame('n3')">N3</button>
                        <button class="chip numeric-chip" data-game="n4" onclick="selectGame('n4')">N4</button>
                        <button class="chip numeric-chip" data-game="n5" onclick="selectGame('n5')">N5</button>
                        <button class="chip numeric-chip" data-game="n6" onclick="selectGame('n6')">N6</button>
                        <button class="chip numeric-chip" data-game="n7" onclick="selectGame('n7')">N7</button>
                        <button class="chip numeric-chip" data-game="n8" onclick="selectGame('n8')">N8</button>
                        <button class="chip numeric-chip" data-game="n9" onclick="selectGame('n9')">N9</button>
                    </div>

                    <!-- Lotto games container -->
                    <div class="lotto-games-container" id="lotto-games">
                        <button class="sub-game-btn" onclick="selectGame('lotto3')">Lotto 3</button>
                        <button class="sub-game-btn" onclick="selectGame('lotto4')">Lotto 4</button>
                        <button class="sub-game-btn" onclick="selectGame('lotto5')">Lotto 5</button>
                        <button class="sub-game-btn auto-chip" onclick="selectGame('auto_lotto4')">Lotto 4 Auto</button>
                        <button class="sub-game-btn auto-chip" onclick="selectGame('auto_lotto5')">Lotto 5 Auto</button>
                    </div>

                    <!-- Special games container -->
                    <div class="special-games-container" id="special-games">
                        <button class="sub-game-btn special-chip" onclick="selectGame('bo')">BO</button>
                        <button class="sub-game-btn special-chip" onclick="selectGame('grap')">GRAP</button>
                        <button class="sub-game-btn" onclick="selectGame('mariage')">Mariage</button>
                        <button class="sub-game-btn auto-chip" onclick="selectGame('auto_marriage')">Mariage Auto</button>
                    </div>

                    <div class="input-container">
                        <input type="text" id="num-input" placeholder="00" inputmode="numeric" maxlength="5" class="num-input">
                        <input type="number" id="amt-input" placeholder="Montan (G)" inputmode="numeric">
                        <button id="add-bet-btn" class="btn-primary-gradient">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </section>

                <section class="cart-section">
                    <div class="cart-header">
                        <div>
                            <h3>Fich an kous</h3>
                            <span id="items-count">0 jwèt</span>
                        </div>
                        <div class="cart-actions">
                            <div class="cart-total" id="cart-total-display">0 Gdes</div>
                            <button onclick="processFinalTicket()" class="print-btn" id="print-cart-btn">
                                <i class="fas fa-print"></i> Enprime Fich
                            </button>
                        </div>
                    </div>
                    <div class="cart-list" id="cart-display">
                        <!-- Cart items will be inserted here -->
                    </div>
                    
                    <div id="cart-summary" style="display: none;">
                        <div class="total-row">
                            <span>Total pou peye:</span>
                            <span id="total-amount">0</span><span> Gdes</span>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Screen 3: History -->
            <section id="history-screen" class="screen">
                <div style="padding: 20px;">
                    <h2 class="section-title">Istorik Tikè</h2>
                    <div class="history-list" id="history-container">
                        <!-- History items will be inserted here -->
                    </div>
                </div>
            </section>

            <!-- Screen 4: Reports -->
            <section id="reports-screen" class="screen">
                <div style="padding: 20px;">
                    <h2 class="section-title">Rapò Jodi a</h2>
                    <div class="report-card">
                        <div class="report-row">
                            <span>Total Tikè:</span>
                            <span class="val" id="total-tickets">0</span>
                        </div>
                        <div class="report-row">
                            <span>Total Pari:</span>
                            <span class="val" id="total-bets">0 Gdes</span>
                        </div>
                        <div class="report-row">
                            <span>Total Ganyen:</span>
                            <span class="val" id="total-wins">0 Gdes</span>
                        </div>
                        <div class="report-row">
                            <span>Pèdi:</span>
                            <span class="val" id="total-loss">0 Gdes</span>
                        </div>
                        <div class="report-row total">
                            <span>Balans:</span>
                            <span class="val" id="balance">0 Gdes</span>
                        </div>
                    </div>

                    <div class="report-card">
                        <h3 style="margin-bottom: 15px;">Detay pa tiraj</h3>
                        <div id="game-breakdown">
                            <!-- Game breakdown will be inserted here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div id="winner-overlay" class="modal-overlay">
            <div class="winner-modal">
                <i class="fas fa-trophy trophy-icon"></i>
                <h2>OU GENYEN !</h2>
                <div id="winner-details"></div>
                <button onclick="closeWinnerModal()" class="btn-close">OK</button>
            </div>
        </div>

        <nav class="nav-bar">
            <a href="#" class="nav-item active" onclick="switchTab('home')">
                <i class="fas fa-dice"></i><span>Jwèt</span>
            </a>
            <a href="#" class="nav-item" onclick="switchTab('history')">
                <i class="fas fa-receipt"></i><span>Istorik</span>
            </a>
            <a href="#" class="nav-item" onclick="switchTab('reports')">
                <i class="fas fa-chart-line"></i><span>Rapò</span>
            </a>
        </nav>
    </div>

    <script>
        // Configuration de l'API
        const API_CONFIG = {
            BASE_URL: window.location.origin + '/api',
            ENDPOINTS: {
                SAVE_TICKET: '/tickets/save',
                GET_TICKETS: '/tickets',
                GET_REPORTS: '/reports',
                GET_DRAWS: '/draws/active',
                VERIFY_AUTH: '/auth/verify',
                LOGOUT: '/auth/logout'
            }
        };

        const CONFIG = {
            CURRENCY: 'Gdes',
            DRAWS: [
                { id: 'D001', name: 'Matin', time: '08:00', color: 'var(--miami)' },
                { id: 'D002', name: 'Midday', time: '12:00', color: 'var(--newyork)' },
                { id: 'D003', name: 'Soir', time: '16:00', color: 'var(--georgia)' },
                { id: 'D004', name: 'Night', time: '20:00', color: 'var(--texas)' }
            ]
        };

        let APP_STATE = {
            selectedDraw: 'D001',
            selectedDraws: ['D001'],
            multiDrawMode: false,
            selectedGame: 'borlette',
            currentCart: [],
            ticketsHistory: [],
            showNumericChips: false,
            showLottoGames: false,
            showSpecialGames: false,
            currentTab: 'home',
            isDrawBlocked: false,
            agentId: '',
            agentName: '',
            token: '',
            salesTotal: 0,
            winningsTotal: 0
        };

        // Fonction pour vérifier si un tirage est bloqué (3 minutes avant)
        function isDrawBlocked(drawTime) {
            const now = new Date();
            const [hours, minutes] = drawTime.split(':').map(Number);
            
            const drawDate = new Date();
            drawDate.setHours(hours, minutes, 0, 0);
            
            // Bloquer 3 minutes avant
            const blockedTime = new Date(drawDate.getTime() - (3 * 60 * 1000));
            
            return now >= blockedTime && now < drawDate;
        }

        // Fonction pour vérifier le tirage sélectionné
        function checkSelectedDrawStatus() {
            const selectedDraw = CONFIG.DRAWS.find(d => d.id === APP_STATE.selectedDraw);
            if (!selectedDraw) return false;
            
            const blocked = isDrawBlocked(selectedDraw.time);
            APP_STATE.isDrawBlocked = blocked;
            
            const warningEl = document.getElementById('draw-blocked-warning');
            const addBetBtn = document.getElementById('add-bet-btn');
            
            if (blocked) {
                warningEl.style.display = 'flex';
                addBetBtn.disabled = true;
                addBetBtn.style.opacity = '0.5';
                addBetBtn.style.cursor = 'not-allowed';
                addBetBtn.innerHTML = '<i class="fas fa-ban"></i>';
            } else {
                warningEl.style.display = 'none';
                addBetBtn.disabled = false;
                addBetBtn.style.opacity = '1';
                addBetBtn.style.cursor = 'pointer';
                addBetBtn.innerHTML = '<i class="fas fa-plus"></i>';
            }
            
            return blocked;
        }

        // Fonctions API avec authentification
        const APIService = {
            async makeRequest(endpoint, method = 'GET', data = null) {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    if (APP_STATE.token) {
                        headers['Authorization'] = `Bearer ${APP_STATE.token}`;
                    }
                    
                    const options = {
                        method,
                        headers,
                    };
                    
                    if (data) {
                        options.body = JSON.stringify(data);
                    }
                    
                    const response = await fetch(`${API_CONFIG.BASE_URL}${endpoint}`, options);
                    
                    if (response.status === 401) {
                        // Token expiré, déconnecter
                        logout();
                        throw new Error('Session expirée');
                    }
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Erreur API:', error);
                    throw error;
                }
            },

            async saveTicket(ticket) {
                return await this.makeRequest(API_CONFIG.ENDPOINTS.SAVE_TICKET, 'POST', ticket);
            },

            async getTickets() {
                const data = await this.makeRequest(`${API_CONFIG.ENDPOINTS.GET_TICKETS}?agentId=${APP_STATE.agentId}`);
                APP_STATE.ticketsHistory = data.tickets || [];
                return data;
            },

            async getReports() {
                return await this.makeRequest(`${API_CONFIG.ENDPOINTS.GET_REPORTS}?agentId=${APP_STATE.agentId}`);
            },

            async getActiveDraws() {
                return await this.makeRequest(API_CONFIG.ENDPOINTS.GET_DRAWS);
            },

            async verifyAuth() {
                return await this.makeRequest(API_CONFIG.ENDPOINTS.VERIFY_AUTH);
            },

            async logout() {
                try {
                    await this.makeRequest(API_CONFIG.ENDPOINTS.LOGOUT, 'POST');
                } catch (error) {
                    // Ignorer les erreurs de déconnexion
                }
            }
        };

        // Fonctions d'interface
        function switchTab(tabName) {
            APP_STATE.currentTab = tabName;
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            let screenId = '';
            switch(tabName) {
                case 'home':
                    screenId = 'draw-selection-screen';
                    document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                    break;
                case 'history':
                    screenId = 'history-screen';
                    document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                    loadHistory();
                    break;
                case 'reports':
                    screenId = 'reports-screen';
                    document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                    loadReports();
                    break;
            }
            
            if (screenId) {
                document.getElementById(screenId).classList.add('active');
            }
        }

        async function loadHistory() {
            try {
                const container = document.getElementById('history-container');
                container.innerHTML = '<div class="empty-msg">Chajman...</div>';
                
                await APIService.getTickets();
                renderHistory();
            } catch (error) {
                document.getElementById('history-container').innerHTML = 
                    '<div class="empty-msg">Erè chajman istorik</div>';
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            
            if (APP_STATE.ticketsHistory.length === 0) {
                container.innerHTML = '<div class="empty-msg">Pa gen tikè nan istorik</div>';
                return;
            }
            
            container.innerHTML = APP_STATE.ticketsHistory.map(ticket => {
                let status = '';
                let statusClass = '';
                
                if (ticket.checked) {
                    const hasWin = ticket.bets && ticket.bets.some(bet => bet.gain > 0);
                    
                    if (hasWin) {
                        status = 'GANYEN';
                        statusClass = 'badge-win';
                    } else {
                        status = 'PÈDI';
                        statusClass = 'badge-lost';
                    }
                } else {
                    status = 'AP TANN';
                    statusClass = 'badge-wait';
                }
                
                return `
                    <div class="history-card">
                        <div class="card-header">
                            <span>#${ticket.ticket_id}</span>
                            <span>${new Date(ticket.created_at).toLocaleDateString('fr-FR')}</span>
                        </div>
                        <div>
                            <p><strong>Tiraj:</strong> ${ticket.draw_name}</p>
                            <p><strong>Total:</strong> ${ticket.total} Gdes</p>
                            <p><strong>Nimewo:</strong> ${ticket.bets ? ticket.bets.length : 0}</p>
                        </div>
                        <div class="card-footer">
                            <span class="badge ${statusClass}">${status}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadReports() {
            try {
                const reports = await APIService.getReports();
                
                document.getElementById('total-tickets').textContent = reports.totalTickets || 0;
                document.getElementById('total-bets').textContent = (reports.totalBets || 0) + ' Gdes';
                document.getElementById('total-wins').textContent = (reports.totalWins || 0) + ' Gdes';
                document.getElementById('total-loss').textContent = (reports.totalLoss || 0) + ' Gdes';
                document.getElementById('balance').textContent = (reports.balance || 0) + ' Gdes';
                document.getElementById('balance').style.color = (reports.balance >= 0) ? 'var(--success)' : 'var(--danger)';
                
                // Game breakdown
                const breakdownContainer = document.getElementById('game-breakdown');
                if (reports.breakdown) {
                    breakdownContainer.innerHTML = Object.entries(reports.breakdown).map(([game, data]) => `
                        <div class="report-row">
                            <span>${game.toUpperCase()}:</span>
                            <span class="val">${data.count} jwèt (${data.amount} Gdes)</span>
                        </div>
                    `).join('');
                } else {
                    breakdownContainer.innerHTML = '<div class="empty-msg">Pa gen done detay</div>';
                }
            } catch (error) {
                console.error('Erreur chargement rapports:', error);
            }
        }

        // Fonctions de jeu (conservées de votre code original)
        const SpecialGames = {
            generateBOBets(amount) {
                const bets = [];
                for (let i = 0; i < 100; i++) {
                    const num = i.toString().padStart(2, '0');
                    if (num[0] === num[1]) {
                        bets.push({
                            id: Date.now() + Math.random(),
                            game: 'borlette',
                            number: num,
                            cleanNumber: num,
                            amount: amount,
                            drawId: APP_STATE.selectedDraw,
                            timestamp: new Date().toISOString(),
                            isAutoGenerated: true,
                            specialType: 'BO'
                        });
                    }
                }
                return bets;
            },

            generateNBets(digit, amount) {
                const bets = [];
                for (let i = 0; i < 100; i++) {
                    const num = i.toString().padStart(2, '0');
                    if (num[1] === digit.toString()) {
                        bets.push({
                            id: Date.now() + Math.random(),
                            game: 'borlette',
                            number: num,
                            cleanNumber: num,
                            amount: amount,
                            drawId: APP_STATE.selectedDraw,
                            timestamp: new Date().toISOString(),
                            isAutoGenerated: true,
                            specialType: `N${digit}`
                        });
                    }
                }
                return bets;
            },

            generateGRAPBets(amount) {
                const bets = [];
                for (let i = 0; i < 10; i++) {
                    const num = i.toString().repeat(3);
                    bets.push({
                        id: Date.now() + Math.random(),
                        game: 'lotto3',
                        number: num,
                        cleanNumber: num,
                        amount: amount,
                        drawId: APP_STATE.selectedDraw,
                        timestamp: new Date().toISOString(),
                        isAutoGenerated: true,
                        specialType: 'GRAP'
                    });
                }
                return bets;
            }
        };

        const GameEngine = {
            validateEntry(type, num) {
                const cleanNum = num.toString().replace(/[-&]/g, '');
                const n = cleanNum;
                
                switch(type) {
                    case 'borlette': return n.length === 2;
                    case 'lotto3':   return n.length === 3;
                    case 'lotto4':   return n.length === 4;
                    case 'lotto5':   return n.length === 5;
                    case 'mariage':  return n.length === 4;
                    case 'auto_marriage': return true;
                    case 'auto_lotto4': return true;
                    case 'auto_lotto5': return true;
                    case 'bo': return true;
                    case 'grap': return true;
                    default: 
                        if (type.startsWith('n')) return true;
                        return false;
                }
            },

            getCleanNumber(num) {
                return num.toString().replace(/[-&]/g, '');
            },

            generateAutoMarriageBets(amount) {
                const borletteNumbers = APP_STATE.currentCart
                    .filter(item => item.game === 'borlette' && this.getCleanNumber(item.number).length === 2)
                    .map(item => this.getCleanNumber(item.number));

                const uniqueNumbers = [...new Set(borletteNumbers)];
                const autoBets = [];
                
                for (let i = 0; i < uniqueNumbers.length; i++) {
                    for (let j = i + 1; j < uniqueNumbers.length; j++) {
                        autoBets.push({
                            id: Date.now() + Math.random(),
                            game: 'auto_marriage',
                            number: uniqueNumbers[i] + '&' + uniqueNumbers[j],
                            cleanNumber: uniqueNumbers[i] + uniqueNumbers[j],
                            amount: amount,
                            drawId: APP_STATE.selectedDraw,
                            timestamp: new Date().toISOString(),
                            isAutoGenerated: true
                        });
                    }
                }
                
                return autoBets;
            },

            generateAutoLotto4Bets(amount) {
                const borletteNumbers = APP_STATE.currentCart
                    .filter(item => item.game === 'borlette' && this.getCleanNumber(item.number).length === 2)
                    .map(item => this.getCleanNumber(item.number));

                const uniqueNumbers = [...new Set(borletteNumbers)];
                const autoBets = [];
                
                for (let i = 0; i < uniqueNumbers.length; i++) {
                    for (let j = 0; j < uniqueNumbers.length; j++) {
                        if (i !== j) {
                            autoBets.push({
                                id: Date.now() + Math.random(),
                                game: 'auto_lotto4',
                                number: uniqueNumbers[i] + '-' + uniqueNumbers[j],
                                cleanNumber: uniqueNumbers[i] + uniqueNumbers[j],
                                amount: amount,
                                drawId: APP_STATE.selectedDraw,
                                timestamp: new Date().toISOString(),
                                isAutoGenerated: true
                            });
                        }
                    }
                }
                
                return autoBets;
            },

            generateAutoLotto5Bets(amount) {
                const lotto3Numbers = APP_STATE.currentCart
                    .filter(item => item.game === 'lotto3' && this.getCleanNumber(item.number).length === 3)
                    .map(item => this.getCleanNumber(item.number));

                const uniqueNumbers = [...new Set(lotto3Numbers)];
                const autoBets = [];
                
                for (let i = 0; i < uniqueNumbers.length; i++) {
                    for (let j = 0; j < uniqueNumbers.length; j++) {
                        if (i !== j) {
                            autoBets.push({
                                id: Date.now() + Math.random(),
                                game: 'auto_lotto5',
                                number: uniqueNumbers[i] + '-' + uniqueNumbers[j].slice(-2),
                                cleanNumber: uniqueNumbers[i] + uniqueNumbers[j].slice(-2),
                                amount: amount,
                                drawId: APP_STATE.selectedDraw,
                                timestamp: new Date().toISOString(),
                                isAutoGenerated: true
                            });
                        }
                    }
                }
                
                return autoBets;
            }
        };

        const CartManager = {
            addBet() {
                if (APP_STATE.isDrawBlocked) {
                    alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute plis paray.");
                    return;
                }

                const numInput = document.getElementById('num-input');
                const amtInput = document.getElementById('amt-input');
                let num = numInput.value.trim();
                const amt = parseFloat(amtInput.value);

                if (isNaN(amt) || amt <= 0) {
                    alert("Tanpri antre yon montan ki valid");
                    return;
                }

                if (APP_STATE.selectedGame === 'bo') {
                    const boBets = SpecialGames.generateBOBets(amt);
                    
                    if (boBets.length === 0) {
                        alert("Pa gen boules paires pou ajoute");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        boBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${boBets.length * draws.length} boules paires ajoute nan panye`);
                    return;
                }

                if (APP_STATE.selectedGame.startsWith('n')) {
                    const digit = parseInt(APP_STATE.selectedGame[1]);
                    const nBets = SpecialGames.generateNBets(digit, amt);
                    
                    if (nBets.length === 0) {
                        alert("Pa gen boules pou ajoute");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        nBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${nBets.length * draws.length} boules (N${digit}) ajoute nan panye`);
                    return;
                }

                if (APP_STATE.selectedGame === 'grap') {
                    const grapBets = SpecialGames.generateGRAPBets(amt);
                    
                    if (grapBets.length === 0) {
                        alert("Pa gen boules grap pou ajoute");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        grapBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${grapBets.length * draws.length} boules grap ajoute nan panye`);
                    return;
                }

                if (APP_STATE.selectedGame.includes('auto')) {
                    if (isNaN(amt) || amt <= 0) {
                        alert("Tanpri antre yon montan ki valid");
                        return;
                    }

                    let autoBets = [];
                    if (APP_STATE.selectedGame === 'auto_marriage') {
                        autoBets = GameEngine.generateAutoMarriageBets(amt);
                    } else if (APP_STATE.selectedGame === 'auto_lotto4') {
                        autoBets = GameEngine.generateAutoLotto4Bets(amt);
                    } else if (APP_STATE.selectedGame === 'auto_lotto5') {
                        autoBets = GameEngine.generateAutoLotto5Bets(amt);
                    }
                    
                    if (autoBets.length === 0) {
                        alert("Pa gen nimewo nan panye pou kreye jwèt otomatik yo");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        autoBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${autoBets.length * draws.length} jwèt otomatik ajoute nan panye`);
                    return;
                }

                if (!GameEngine.validateEntry(APP_STATE.selectedGame, num)) {
                    alert("Nimewo sa pa bon pou " + APP_STATE.selectedGame);
                    return;
                }

                num = GameEngine.getCleanNumber(num);
                
                let displayNum = num;
                if (APP_STATE.selectedGame === 'lotto4' && num.length === 4) {
                    displayNum = num.slice(0, 2) + '-' + num.slice(2, 4);
                } else if (APP_STATE.selectedGame === 'lotto5' && num.length === 5) {
                    displayNum = num.slice(0, 3) + '-' + num.slice(3, 5);
                } else if (APP_STATE.selectedGame === 'mariage' && num.length === 4) {
                    displayNum = num.slice(0, 2) + '&' + num.slice(2, 4);
                }

                const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                
                draws.forEach(drawId => {
                    const bet = {
                        id: Date.now() + Math.random(),
                        game: APP_STATE.selectedGame,
                        number: displayNum,
                        cleanNumber: num,
                        amount: amt,
                        drawId: drawId,
                        drawName: CONFIG.DRAWS.find(d => d.id === drawId).name,
                        timestamp: new Date().toISOString(),
                        isAutoGenerated: false,
                        isSpecial: false
                    };

                    APP_STATE.currentCart.push(bet);
                });
                
                this.renderCart();
                
                numInput.value = '';
                amtInput.value = '';
                numInput.focus();
            },

            removeBet(id) {
                APP_STATE.currentCart = APP_STATE.currentCart.filter(item => item.id !== id);
                this.renderCart();
            },

            renderCart() {
                const display = document.getElementById('cart-display');
                const summary = document.getElementById('cart-summary');
                const totalDisplay = document.getElementById('total-amount');
                const countDisplay = document.getElementById('items-count');
                const cartTotalDisplay = document.getElementById('cart-total-display');

                if (APP_STATE.currentCart.length === 0) {
                    display.innerHTML = '<div class="empty-msg">Pa gen paray ankò</div>';
                    summary.style.display = 'none';
                    countDisplay.innerText = "0 jwèt";
                    cartTotalDisplay.innerText = "0 Gdes";
                    return;
                }

                let total = 0;
                display.innerHTML = APP_STATE.currentCart.map(item => {
                    total += item.amount;
                    let gameName = '';
                    
                    if (item.isAutoGenerated && item.specialType) {
                        gameName = item.specialType.toUpperCase();
                    } else if (item.isAutoGenerated) {
                        gameName = `${item.game.replace('_', ' ').toUpperCase()}*`;
                    } else {
                        gameName = item.game.toUpperCase();
                    }
                    
                    const drawName = APP_STATE.multiDrawMode ? item.drawName : '';
                    
                    return `
                        <div class="cart-item animate-fade">
                            <div class="item-info">
                                <span class="item-game">${gameName} ${item.number}</span>
                                ${APP_STATE.multiDrawMode ? `<span style="font-size:0.8rem; color:var(--text-dim)">${drawName}</span>` : ''}
                            </div>
                            <div class="item-price">
                                <span>${item.amount} ${CONFIG.CURRENCY}</span>
                                <button onclick="CartManager.removeBet(${item.id})" style="background:none; border:none; color:var(--danger); cursor:pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                totalDisplay.innerText = total;
                countDisplay.innerText = APP_STATE.currentCart.length + " jwèt";
                cartTotalDisplay.innerText = total.toLocaleString() + " Gdes";
                summary.style.display = 'block';
                
                display.scrollTop = display.scrollHeight;
            }
        };

        async function processFinalTicket() {
            if (APP_STATE.currentCart.length === 0) {
                alert("Pa gen anyen nan panye an!");
                return;
            }

            if (APP_STATE.isDrawBlocked) {
                alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka enprime fich.");
                return;
            }

            const betsByDraw = {};
            APP_STATE.currentCart.forEach(bet => {
                if (!betsByDraw[bet.drawId]) {
                    betsByDraw[bet.drawId] = [];
                }
                betsByDraw[bet.drawId].push(bet);
            });

            const drawIds = Object.keys(betsByDraw);
            let tickets = [];
            
            try {
                for (const drawId of drawIds) {
                    const drawBets = betsByDraw[drawId];
                    const draw = CONFIG.DRAWS.find(d => d.id === drawId);
                    
                    const ticket = {
                        drawId: drawId,
                        drawName: draw.name,
                        bets: drawBets,
                        total: drawBets.reduce((sum, b) => sum + b.amount, 0),
                    };

                    // Sauvegarde via API
                    const savedTicket = await APIService.saveTicket(ticket);
                    tickets.push(savedTicket);
                    
                    // Mise à jour de l'historique local
                    if (savedTicket.ticket) {
                        APP_STATE.ticketsHistory.unshift(savedTicket.ticket);
                    }
                }
                
                // Réinitialisation du panier
                APP_STATE.currentCart = [];
                CartManager.renderCart();
                
                if (tickets.length === 1) {
                    alert("Fich sove ak siksè! #" + tickets[0].ticket?.ticket_id);
                } else {
                    alert(`${tickets.length} fich sove ak siksè!`);
                }
                
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                if (error.message === 'Session expirée') {
                    alert("Session expirée. Tanpri rekonekte.");
                    logout();
                } else {
                    alert("Erè sou sèvè a. Fich la pa sove.");
                }
            }
        }

        function setupInputAutoMove() {
            const numInput = document.getElementById('num-input');
            const amtInput = document.getElementById('amt-input');
            
            numInput.addEventListener('input', function(e) {
                const game = APP_STATE.selectedGame;
                let maxLength = 5;
                
                switch(game) {
                    case 'borlette': maxLength = 2; break;
                    case 'lotto3': maxLength = 3; break;
                    case 'lotto4': maxLength = 4; break;
                    case 'lotto5': maxLength = 5; break;
                    case 'mariage': maxLength = 4; break;
                    case 'auto_marriage': maxLength = 0; break;
                    case 'auto_lotto4': maxLength = 0; break;
                    case 'auto_lotto5': maxLength = 0; break;
                    case 'bo': maxLength = 0; break;
                    case 'grap': maxLength = 0; break;
                }
                
                if (game.startsWith('n')) {
                    maxLength = 0;
                }
                
                if (this.value.length >= maxLength && maxLength > 0) {
                    amtInput.focus();
                    amtInput.select();
                }
                
                if (game === 'lotto4' && this.value.length === 4) {
                    this.value = this.value.replace(/(\d{2})(\d{2})/, '$1-$2');
                } else if (game === 'lotto5' && this.value.length === 5) {
                    this.value = this.value.replace(/(\d{3})(\d{2})/, '$1-$2');
                } else if (game === 'mariage' && this.value.length === 4) {
                    this.value = this.value.replace(/(\d{2})(\d{2})/, '$1&$2');
                }
            });
            
            amtInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    CartManager.addBet();
                }
            });
        }

        // Fonctions de navigation (conservées de votre code original)
        function toggleMultiDrawMode() {
            APP_STATE.multiDrawMode = !APP_STATE.multiDrawMode;
            const btn = document.getElementById('multi-draw-btn');
            const multiContainer = document.getElementById('multi-draw-container');
            const continueBtn = document.getElementById('multi-draw-continue');
            const drawGrid = document.getElementById('draws-container');
            
            if (APP_STATE.multiDrawMode) {
                btn.innerHTML = '<i class="fas fa-times"></i> Sispann Plizyè Tiraj';
                btn.style.background = 'rgba(255, 77, 77, 0.2)';
                btn.style.borderColor = 'var(--danger)';
                btn.style.color = 'var(--danger)';
                multiContainer.style.display = 'flex';
                continueBtn.style.display = 'block';
                drawGrid.style.display = 'none';
                renderMultiDrawSelector();
            } else {
                btn.innerHTML = '<i class="fas fa-layer-group"></i> Plizyè Tiraj';
                btn.style.background = 'rgba(0, 212, 255, 0.2)';
                btn.style.borderColor = 'var(--secondary)';
                btn.style.color = 'var(--secondary)';
                multiContainer.style.display = 'none';
                continueBtn.style.display = 'none';
                drawGrid.style.display = 'grid';
            }
        }

        function renderMultiDrawSelector() {
            const container = document.getElementById('multi-draw-container');
            container.innerHTML = CONFIG.DRAWS.map(draw => {
                const blocked = isDrawBlocked(draw.time);
                return `
                    <input type="checkbox" class="multi-draw-checkbox" id="multi-${draw.id}" 
                           value="${draw.id}" ${APP_STATE.selectedDraws.includes(draw.id) && !blocked ? 'checked' : ''}
                           ${blocked ? 'disabled' : ''}
                           onchange="toggleMultiDrawSelection('${draw.id}')">
                    <label for="multi-${draw.id}" class="multi-draw-label" style="border-left: 3px solid ${draw.color}; ${blocked ? 'opacity: 0.5;' : ''}">
                        ${draw.name} ${blocked ? '(BLOKÉ)' : ''}
                    </label>
                `;
            }).join('');
        }

        function toggleMultiDrawSelection(drawId) {
            const checkbox = document.getElementById(`multi-${drawId}`);
            if (checkbox.checked) {
                if (!APP_STATE.selectedDraws.includes(drawId)) {
                    APP_STATE.selectedDraws.push(drawId);
                }
            } else {
                APP_STATE.selectedDraws = APP_STATE.selectedDraws.filter(id => id !== drawId);
            }
            
            document.getElementById('selected-draws-count').textContent = APP_STATE.selectedDraws.length;
        }

        function continueToBettingWithMultiDraw() {
            if (APP_STATE.selectedDraws.length === 0) {
                alert("Tanpri chwazi omwen yon tiraj");
                return;
            }
            
            APP_STATE.selectedDraw = APP_STATE.selectedDraws[0];
            const draw = CONFIG.DRAWS.find(d => d.id === APP_STATE.selectedDraw);
            document.getElementById('current-draw-title').textContent = draw.name;
            
            const indicator = document.getElementById('multi-draw-indicator');
            indicator.style.display = 'block';
            document.getElementById('selected-draws-count').textContent = APP_STATE.selectedDraws.length;
            
            document.getElementById('draw-selection-screen').classList.remove('active');
            document.getElementById('betting-screen').classList.add('active');
            document.querySelector('.back-button').style.display = 'flex';
            
            updateGameSelector();
            checkSelectedDrawStatus();
        }

        function renderDraws() {
            const container = document.getElementById('draws-container');
            container.innerHTML = CONFIG.DRAWS.map(draw => {
                const blocked = isDrawBlocked(draw.time);
                const isActive = APP_STATE.selectedDraw === draw.id && !blocked;
                
                return `
                    <div class="draw-card ${isActive ? 'active' : ''} ${blocked ? 'blocked' : ''}" 
                         onclick="${blocked ? '' : `selectDraw('${draw.id}')`}" 
                         style="--draw-color: ${draw.color}">
                        <span class="draw-name">${draw.name}</span>
                        <span class="draw-time"><i class="far fa-clock"></i> ${draw.time}</span>
                        ${blocked ? '<span class="blocked-badge">BLOKÉ</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        function selectDraw(id) {
            if (APP_STATE.multiDrawMode) return;
            
            const draw = CONFIG.DRAWS.find(d => d.id === id);
            if (isDrawBlocked(draw.time)) {
                alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute paray.");
                return;
            }
            
            APP_STATE.selectedDraw = id;
            APP_STATE.selectedDraws = [id];
            document.getElementById('current-draw-title').textContent = draw.name;
            
            document.getElementById('multi-draw-indicator').style.display = 'none';
            
            document.getElementById('draw-selection-screen').classList.remove('active');
            document.getElementById('betting-screen').classList.add('active');
            document.querySelector('.back-button').style.display = 'flex';
            
            updateGameSelector();
            checkSelectedDrawStatus();
        }

        function goBackToDraws() {
            document.getElementById('betting-screen').classList.remove('active');
            document.getElementById('draw-selection-screen').classList.add('active');
            document.querySelector('.back-button').style.display = 'none';
            
            APP_STATE.multiDrawMode = false;
            const btn = document.getElementById('multi-draw-btn');
            btn.innerHTML = '<i class="fas fa-layer-group"></i> Plizyè Tiraj';
            btn.style.background = 'rgba(0, 212, 255, 0.2)';
            btn.style.borderColor = 'var(--secondary)';
            btn.style.color = 'var(--secondary)';
            
            document.getElementById('multi-draw-container').style.display = 'none';
            document.getElementById('multi-draw-continue').style.display = 'none';
            document.getElementById('draws-container').style.display = 'grid';
            
            renderDraws();
        }

        function toggleNumericChips() {
            APP_STATE.showNumericChips = !APP_STATE.showNumericChips;
            const container = document.getElementById('numeric-chips');
            const btn = document.getElementById('toggle-nx-btn');
            
            if (APP_STATE.showNumericChips) {
                container.classList.add('visible');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> NX';
            } else {
                container.classList.remove('visible');
                btn.classList.remove('active');
                btn.innerHTML = 'NX';
            }
            
            APP_STATE.showLottoGames = false;
            APP_STATE.showSpecialGames = false;
            document.getElementById('lotto-games').classList.remove('visible');
            document.getElementById('special-games').classList.remove('visible');
            
            document.querySelectorAll('#game-types .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('#game-types .chip[data-game="borlette"]').classList.add('active');
        }

        function toggleLottoOption(gameType, optionIndex) {
            if (gameType === 4) {
                // Gérer les options pour lotto4
            } else if (gameType === 5) {
                // Gérer les options pour lotto5
            }
            
            const optionChip = document.querySelector(`#lotto${gameType}-options .option-chip[data-option="${optionIndex}"]`);
            if (optionChip) {
                optionChip.classList.toggle('active');
                optionChip.classList.add('animate-bounce');
                setTimeout(() => {
                    optionChip.classList.remove('animate-bounce');
                }, 500);
            }
        }

        function selectGame(game) {
            if (APP_STATE.isDrawBlocked) {
                alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute plis paray.");
                return;
            }
            
            APP_STATE.selectedGame = game;
            const input = document.getElementById('num-input');
            
            document.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.sub-game-btn').forEach(b => b.classList.remove('active'));
            
            if (game.startsWith('n')) {
                document.querySelector(`.numeric-chip[data-game="${game}"]`).classList.add('active');
            }
            
            document.querySelector('#game-types .chip[data-game="borlette"]').classList.add('active');
            
            const placeholderMap = {
                'borlette': '00',
                'lotto3': '000',
                'lotto4': '0000',
                'lotto5': '00000',
                'mariage': '0000',
                'auto_marriage': 'Auto',
                'auto_lotto4': 'Auto',
                'auto_lotto5': 'Auto',
                'bo': 'Auto',
                'grap': 'Auto'
            };
            
            input.placeholder = placeholderMap[game] || '00';
            
            if (game.includes('auto') || game === 'bo' || game === 'grap' || game.startsWith('n')) {
                input.disabled = true;
                input.value = '';
                input.placeholder = 'Auto-genere';
            } else {
                input.disabled = false;
                input.focus();
            }
            
            const lotto4Options = document.getElementById('lotto4-options');
            const lotto5Options = document.getElementById('lotto5-options');
            
            if (game === 'lotto4' || game === 'auto_lotto4') {
                lotto4Options.classList.add('visible');
                lotto5Options.classList.remove('visible');
            } else if (game === 'lotto5' || game === 'auto_lotto5') {
                lotto5Options.classList.add('visible');
                lotto4Options.classList.remove('visible');
            } else {
                lotto4Options.classList.remove('visible');
                lotto5Options.classList.remove('visible');
            }
        }

        function updateGameSelector() {
            const gameSelector = document.getElementById('game-types');
            gameSelector.innerHTML = `
                <button class="chip active" data-game="borlette" onclick="selectMainGame('borlette')">Borlette</button>
                <button class="chip" data-game="lotto" onclick="selectMainGame('lotto')">Lotto</button>
                <button class="chip" data-game="special" onclick="selectMainGame('special')">Jeux Spéciaux</button>
                <button class="chip" id="toggle-nx-btn" onclick="toggleNumericChips()">NX</button>
            `;
            
            document.querySelectorAll('.sub-game-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const game = this.getAttribute('onclick').match(/selectGame\('(\w+)'\)/)[1];
                    selectGame(game);
                    this.classList.add('active');
                });
            });
            
            selectGame('borlette');
        }

        function selectMainGame(game) {
            APP_STATE.showNumericChips = false;
            document.getElementById('numeric-chips').classList.remove('visible');
            document.getElementById('toggle-nx-btn').classList.remove('active');
            document.getElementById('toggle-nx-btn').innerHTML = 'NX';
            
            document.querySelectorAll('#game-types .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`#game-types .chip[data-game="${game}"]`).classList.add('active');
            
            if (game === 'lotto') {
                APP_STATE.showLottoGames = !APP_STATE.showLottoGames;
                APP_STATE.showSpecialGames = false;
                
                if (APP_STATE.showLottoGames) {
                    document.getElementById('lotto-games').classList.add('visible');
                    document.getElementById('special-games').classList.remove('visible');
                } else {
                    document.getElementById('lotto-games').classList.remove('visible');
                }
            } else if (game === 'special') {
                APP_STATE.showSpecialGames = !APP_STATE.showSpecialGames;
                APP_STATE.showLottoGames = false;
                
                if (APP_STATE.showSpecialGames) {
                    document.getElementById('special-games').classList.add('visible');
                    document.getElementById('lotto-games').classList.remove('visible');
                } else {
                    document.getElementById('special-games').classList.remove('visible');
                }
            } else if (game === 'borlette') {
                APP_STATE.showLottoGames = false;
                APP_STATE.showSpecialGames = false;
                document.getElementById('lotto-games').classList.remove('visible');
                document.getElementById('special-games').classList.remove('visible');
                selectGame('borlette');
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('live-clock').innerText = now.toLocaleTimeString('fr-FR');
            
            // Vérifier le statut du tirage toutes les 30 secondes
            if (APP_STATE.currentTab === 'home' || APP_STATE.currentTab === 'betting') {
                checkSelectedDrawStatus();
            }
        }

        function closeWinnerModal() {
            document.getElementById('winner-overlay').style.display = 'none';
        }

        function logout() {
            APIService.logout();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        async function initApp() {
            // Récupérer le token et les infos utilisateur
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (!token || !userStr) {
                window.location.href = '/';
                return;
            }
            
            try {
                APP_STATE.token = token;
                const user = JSON.parse(userStr);
                APP_STATE.agentId = user.agentId;
                APP_STATE.agentName = user.name;
                
                // Mettre à jour l'interface
                document.getElementById('agent-name').textContent = user.name;
                
                // Vérifier que le token est toujours valide
                await APIService.verifyAuth();
                
                // Charger les tirages actifs
                try {
                    const drawsData = await APIService.getActiveDraws();
                    if (drawsData.draws && drawsData.draws.length > 0) {
                        CONFIG.DRAWS = drawsData.draws.map(draw => ({
                            id: draw.drawId,
                            name: draw.drawName,
                            time: draw.drawTime,
                            color: draw.isActive ? 'var(--primary)' : 'var(--text-dim)'
                        }));
                    }
                } catch (error) {
                    console.log('Utilisation des tirages par défaut');
                }
                
                renderDraws();
                updateClock();
                checkSelectedDrawStatus();
                
                console.log("LOTATO PRO Agent Ready");

                setupInputAutoMove();
                
                document.getElementById('add-bet-btn').addEventListener('click', () => CartManager.addBet());
                
                updateGameSelector();
                
            } catch (error) {
                console.error('Erreur initialisation:', error);
                alert("Session expirée. Tanpri rekonekte.");
                logout();
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
        setInterval(updateClock, 1000);
        setInterval(checkSelectedDrawStatus, 30000);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('PWA: Service Worker actif'))
                .catch(err => console.error('PWA: Erreur', err));
        }
    </script>
</body>
</html>