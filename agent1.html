<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LOTATO PRO | Nova System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <style>
        :root {
            --primary: #ad00f1;
            --secondary: #00d4ff;
            --accent: #ff007a;
            --bg: #0a0b1e;
            --surface: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(81, 6, 75, 0.699);
            --text-main: #ffffff;
            --text-dim: #a0a0b8;
            --success: #00f190;
            --danger: #ff4d4d;
            --warning: #ffa502;
            --profit: #00ff88;
            --loss: #ff4757;
            --miami: #ff4757;
            --newyork: #ffa502;
            --georgia: #2ed573;
            --texas: #ff6b35;
            --tunisia: #00cec9;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            background: radial-gradient(circle at top right, #1a1b3a, #0a0b1e);
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes pulseActive { 0% { box-shadow: 0 0 0 0 rgba(173, 0, 241, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(173, 0, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(173, 0, 241, 0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 60%, 100% { transform: translateY(0); } 40% { transform: translateY(-5px); } 80% { transform: translateY(-2px); } }

        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        .pulse-active { animation: pulseActive 1.5s infinite; }
        .animate-bounce { animation: bounce 0.5s; }

        /* Layout Global */
        .app-shell {
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            padding: 20px;
            backdrop-filter: blur(15px);
            position: sticky;
            top: 0; z-index: 1000;
            display: flex; justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .brand h1 {
            font-size: 1.5rem;
        }

        .pro-badge {
            background: var(--primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tirages */
        .draw-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 20px;
        }

        .draw-card {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .draw-card.active {
            background: rgba(173, 0, 241, 0.1);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(173, 0, 241, 0.2);
        }

        .draw-card.blocked {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .draw-card.blocked::after {
            content: "BLOKÉ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Betting Panel */
        .betting-panel {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: 32px 32px 0 0;
            padding: 25px 20px;
            border-top: 1px solid var(--glass-border);
            margin-top: auto;
        }

        .game-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .game-selector::-webkit-scrollbar {
            height: 3px;
        }

        .chip {
            padding: 8px 14px;
            border-radius: 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(173, 0, 241, 0.3);
        }

        .chip.numeric-chip {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .chip.numeric-chip.active {
            background: var(--secondary);
            color: black;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .chip.special-chip {
            background: rgba(255, 0, 122, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .chip.special-chip.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 15px rgba(255, 0, 122, 0.5);
        }

        .chip.auto-chip {
            background: rgba(0, 241, 144, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .chip.auto-chip.active {
            background: var(--success);
            color: black;
            box-shadow: 0 0 15px rgba(0, 241, 144, 0.5);
        }

        .chip.lotto-chip {
            background: rgba(255, 165, 2, 0.1);
            border-color: #ffa502;
            color: #ffa502;
        }

        .chip.lotto-chip.active {
            background: #ffa502;
            color: black;
            box-shadow: 0 0 15px rgba(255, 165, 2, 0.5);
        }

        .input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        input {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 16px;
            color: white;
            font-size: 1.1rem;
            width: 100%;
            outline: none;
            transition: 0.2s;
            text-align: center;
        }

        input:focus { border-color: var(--secondary); background: rgba(0,0,0,0.4); }

        .btn-primary-gradient {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            min-width: 60px;
        }

        /* Cart */
        .cart-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 400px);
            min-height: 300px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cart-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .cart-total {
            background: rgba(173, 0, 241, 0.1);
            padding: 10px 15px;
            border-radius: 12px;
            font-weight: bold;
            border: 1px solid var(--primary);
        }

        .print-btn {
            background: var(--success);
            border: none;
            border-radius: 12px;
            color: black;
            font-weight: bold;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .print-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 241, 144, 0.5);
        }

        .cart-list {
            flex: 1;
            overflow-y: auto;
            margin: 15px 0;
        }

        .cart-item {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--primary);
            animation: fadeIn 0.3s ease;
        }

        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 11, 30, 0.95);
            backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding: 15px 10px 25px 10px;
            border-top: 1px solid var(--glass-border);
            z-index: 1000;
        }

        .nav-item {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.75rem;
            text-align: center;
            flex: 1;
            transition: color 0.3s;
        }

        .nav-item.active { 
            color: var(--secondary); 
            transform: translateY(-5px);
        }
        .nav-item.active i { 
            text-shadow: 0 0 10px var(--secondary);
        }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; transition: all 0.3s; }

        /* Historique */
        .history-screen {
            padding: 20px;
        }
        .history-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
        .history-card {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px;
        }
        .card-header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px; margin-bottom: 10px; font-size: 0.8rem; color: var(--text-dim); }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .btn-small { background: rgba(255,255,255,0.1); border: none; color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-wait { background: #555; color: white; }
        .badge-win { background: var(--success); color: black; box-shadow: 0 0 10px var(--success); }
        .badge-lost { background: rgba(255,0,0,0.2); color: #ff4d4d; }

        /* Rapports */
        .reports-screen {
            padding: 20px;
        }
        .report-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
        }
        .report-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 1rem;
        }
        .report-row.total {
            font-weight: 800;
            font-size: 1.2rem;
            border-top: 2px solid var(--glass-border);
            margin-top: 10px;
        }
        .val { font-family: 'Courier New', monospace; font-weight: bold; }

        /* Écran Gagnants */
        .winners-screen {
            padding: 20px;
        }
        
        .winners-summary {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .summary-row.total {
            font-weight: bold;
            font-size: 1.2rem;
            border-top: 2px solid var(--glass-border);
            margin-top: 10px;
            padding-top: 15px;
        }
        
        .profit { color: var(--profit); }
        .loss { color: var(--loss); }
        
        .winner-ticket {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--glass-border);
        }
        
        .winner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .winner-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-pay {
            background: var(--success);
            border: none;
            border-radius: 10px;
            color: black;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        
        .btn-pay:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-need-funds {
            background: var(--warning);
            border: none;
            border-radius: 10px;
            color: black;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        
        .btn-paid {
            background: var(--secondary);
            border: none;
            border-radius: 10px;
            color: black;
            padding: 8px 15px;
            font-weight: bold;
            flex: 1;
        }
        
        .agent-funds {
            background: linear-gradient(135deg, #1a1b3a, #0a0b1e);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--primary);
            text-align: center;
        }
        
        .funds-amount {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
            color: var(--secondary);
        }
        
        .add-funds-btn {
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        /* Modal Winner */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .winner-modal {
            background: var(--bg);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            border: 2px solid var(--success);
        }

        .trophy-icon {
            font-size: 4rem;
            color: gold;
            margin-bottom: 20px;
        }

        .btn-close {
            background: var(--primary);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 12px;
            margin-top: 20px;
            cursor: pointer;
        }
        
        /* Modal Funds */
        .funds-modal {
            background: var(--bg);
            border-radius: 24px;
            padding: 30px;
            max-width: 90%;
            width: 400px;
            border: 2px solid var(--secondary);
        }
        
        .modal-input {
            width: 100%;
            margin: 15px 0;
            padding: 15px;
            font-size: 1.2rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-btn.confirm {
            background: var(--success);
            color: black;
        }
        
        .modal-btn.cancel {
            background: var(--danger);
            color: white;
        }

        /* Sync Bar */
        .sync-idle {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
        }

        /* Screen States */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }

        /* Multi-draw selection */
        .multi-draw-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
        }

        .multi-draw-checkbox {
            display: none;
        }

        .multi-draw-label {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .multi-draw-checkbox:checked + .multi-draw-label {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 10px rgba(173, 0, 241, 0.5);
        }

        .multi-draw-toggle {
            padding: 8px 16px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid var(--secondary);
            border-radius: 12px;
            color: var(--secondary);
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        /* Ticket summary */
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin: 10px 0;
            font-size: 1.2rem;
        }

        .btn-success-full {
            background: var(--success);
            border: none;
            border-radius: 16px;
            color: black;
            font-weight: bold;
            padding: 16px;
            width: 100%;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .multi-draw-indicator {
            background: rgba(0,212,255,0.1);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin: 10px 20px;
        }

        .empty-msg {
            text-align: center;
            color: var(--text-dim);
            padding: 20px;
        }

        /* Back button */
        .back-button {
            background: none;
            border: none;
            color: var(--secondary);
            font-size: 1.2rem;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Numeric chips container */
        .numeric-chips-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            animation: slideDown 0.3s ease-out;
        }

        .numeric-chips-container.visible {
            display: flex;
        }

        /* Lotto 4/5 options */
        .lotto-options {
            display: none;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            flex-wrap: wrap;
        }

        .lotto-options.visible {
            display: flex;
        }

        .option-chip {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .option-chip.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--secondary);
            color: var(--secondary);
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .option-chip input {
            display: none;
        }

        /* Game group containers */
        .special-games-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            animation: slideDown 0.3s ease-out;
        }

        .special-games-container.visible {
            display: flex;
        }

        .lotto-games-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            animation: slideDown 0.3s ease-out;
        }

        .lotto-games-container.visible {
            display: flex;
        }

        /* Toggle buttons */
        .toggle-btn {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--secondary);
            border-radius: 12px;
            color: var(--secondary);
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-btn.active {
            background: var(--secondary);
            color: black;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .sub-game-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .sub-game-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Warning message */
        .warning-message {
            background: rgba(255, 165, 2, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 10px 15px;
            border-radius: 12px;
            margin: 10px 20px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 10px;
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Configuration button */
        .config-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }
        
        /* Lottery configuration */
        .lottery-config {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .config-modal {
            background: var(--bg);
            border-radius: 24px;
            padding: 30px;
            max-width: 90%;
            width: 400px;
            border: 2px solid var(--primary);
        }
        
        .config-item {
            margin: 15px 0;
        }
        
        .config-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-dim);
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <div id="sync-status-bar" class="sync-idle">
            <span id="sync-text">Vérification des résultats...</span>
        </div>

        <header>
            <div class="brand">
                <h1 class="logo-text" id="lottery-name">LOTATO PRO <span class="pro-badge">vession 6</span></h1>
                <div id="live-clock">00:00:00</div>
            </div>
            <div class="user-profile">
                <i class="fas fa-user-circle"></i>
                <span id="agent-name">Agent-01</span>
                <button class="config-btn" onclick="openLotteryConfig()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <main class="content-area">
            <!-- Screen 1: Draw Selection -->
            <section id="draw-selection-screen" class="screen active">
                <button class="back-button" onclick="goBackToDraws()" style="display:none;">
                    <i class="fas fa-arrow-left"></i> Retounen
                </button>
                <h2 class="section-title">Chwazi Tiraj</h2>
                
                <div style="padding: 0 20px 10px 20px;">
                    <button id="multi-draw-btn" class="multi-draw-toggle" onclick="toggleMultiDrawMode()">
                        <i class="fas fa-layer-group"></i> Plizyè Tiraj
                    </button>
                </div>

                <div id="multi-draw-container" class="multi-draw-selector" style="display: none;">
                    <!-- Multi-draw checkboxes will be inserted here -->
                </div>

                <div class="draw-grid" id="draws-container">
                    <!-- Draw cards will be inserted here -->
                </div>

                <div id="multi-draw-continue" style="display: none; padding: 20px;">
                    <button onclick="continueToBettingWithMultiDraw()" class="btn-success-full">
                        <i class="fas fa-play"></i> Kontinye ak Tiraj Chwazi yo
                    </button>
                </div>
            </section>

            <!-- Screen 2: Betting Interface -->
            <section id="betting-screen" class="screen">
                <button class="back-button" onclick="goBackToDraws()">
                    <i class="fas fa-arrow-left"></i> Retounen
                </button>
                <h2 class="section-title" id="current-draw-title">Miami Matin</h2>
                
                <div id="draw-blocked-warning" class="warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute plis paray.</span>
                </div>

                <!-- Multi-draw indicator -->
                <div id="multi-draw-indicator" class="multi-draw-indicator" style="display: none;">
                    <i class="fas fa-layer-group"></i> Jwe pou plizyè tiraj: <span id="selected-draws-count">1</span> tiraj
                </div>

                <!-- Lotto 4 Options -->
                <div id="lotto4-options" class="lotto-options">
                    <div class="option-chip active" data-option="1" onclick="toggleLottoOption(4, 1)">
                        <input type="checkbox" id="opt1-4" checked>
                        <label for="opt1-4">1e Opsyon (2e & 3e)</label>
                    </div>
                    <div class="option-chip active" data-option="2" onclick="toggleLottoOption(4, 2)">
                        <input type="checkbox" id="opt2-4" checked>
                        <label for="opt2-4">2e Opsyon (1e & 2e)</label>
                    </div>
                    <div class="option-chip active" data-option="3" onclick="toggleLottoOption(4, 3)">
                        <input type="checkbox" id="opt3-4" checked>
                        <label for="opt3-4">3e Opsyon (1e & 3e)</label>
                    </div>
                </div>

                <!-- Lotto 5 Options -->
                <div id="lotto5-options" class="lotto-options">
                    <div class="option-chip active" data-option="1" onclick="toggleLottoOption(5, 1)">
                        <input type="checkbox" id="opt1-5" checked>
                        <label for="opt1-5">1e Opsyon (1e lot & 2e lot)</label>
                    </div>
                    <div class="option-chip active" data-option="2" onclick="toggleLottoOption(5, 2)">
                        <input type="checkbox" id="opt2-5" checked>
                        <label for="opt2-5">2e Opsyon (1e lot & 3e lot)</label>
                    </div>
                    <div class="option-chip active" data-option="3" onclick="toggleLottoOption(5, 3)">
                        <input type="checkbox" id="opt3-5" checked>
                        <label for="opt3-5">3e Opsyon (1e lot & 1e lot)</label>
                    </div>
                </div>

                <section class="betting-panel animate-fade">
                    <div class="game-selector" id="game-types">
                        <button class="chip active" data-game="borlette">Borlette</button>
                        <button class="chip" data-game="lotto">Lotto</button>
                        <button class="chip" data-game="special">Jeux Spéciaux</button>
                        <button class="chip" id="toggle-nx-btn" onclick="toggleNumericChips()">NX</button>
                    </div>

                    <!-- Numeric chips for N0-N9 (hidden by default) -->
                    <div class="numeric-chips-container" id="numeric-chips">
                        <button class="chip numeric-chip" data-game="n0" onclick="selectGame('n0')">N0</button>
                        <button class="chip numeric-chip" data-game="n1" onclick="selectGame('n1')">N1</button>
                        <button class="chip numeric-chip" data-game="n2" onclick="selectGame('n2')">N2</button>
                        <button class="chip numeric-chip" data-game="n3" onclick="selectGame('n3')">N3</button>
                        <button class="chip numeric-chip" data-game="n4" onclick="selectGame('n4')">N4</button>
                        <button class="chip numeric-chip" data-game="n5" onclick="selectGame('n5')">N5</button>
                        <button class="chip numeric-chip" data-game="n6" onclick="selectGame('n6')">N6</button>
                        <button class="chip numeric-chip" data-game="n7" onclick="selectGame('n7')">N7</button>
                        <button class="chip numeric-chip" data-game="n8" onclick="selectGame('n8')">N8</button>
                        <button class="chip numeric-chip" data-game="n9" onclick="selectGame('n9')">N9</button>
                    </div>

                    <!-- Lotto games container -->
                    <div class="lotto-games-container" id="lotto-games">
                        <button class="sub-game-btn" onclick="selectGame('lotto3')">Lotto 3</button>
                        <button class="sub-game-btn" onclick="selectGame('lotto4')">Lotto 4</button>
                        <button class="sub-game-btn" onclick="selectGame('lotto5')">Lotto 5</button>
                        <button class="sub-game-btn auto-chip" onclick="selectGame('auto_lotto4')">Lotto 4 Auto</button>
                        <button class="sub-game-btn auto-chip" onclick="selectGame('auto_lotto5')">Lotto 5 Auto</button>
                    </div>

                    <!-- Special games container -->
                    <div class="special-games-container" id="special-games">
                        <button class="sub-game-btn special-chip" onclick="selectGame('bo')">BO</button>
                        <button class="sub-game-btn special-chip" onclick="selectGame('grap')">GRAP</button>
                        <button class="sub-game-btn" onclick="selectGame('mariage')">Mariage</button>
                        <button class="sub-game-btn auto-chip" onclick="selectGame('auto_marriage')">Mariage Auto</button>
                    </div>

                    <div class="input-container">
                        <input type="text" id="num-input" placeholder="00" inputmode="numeric" maxlength="5" class="num-input">
                        <input type="number" id="amt-input" placeholder="Montan (G)" inputmode="numeric">
                        <button id="add-bet-btn" class="btn-primary-gradient">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </section>

                <section class="cart-section">
                    <div class="cart-header">
                        <div>
                            <h3>Fich an kous</h3>
                            <span id="items-count">0 jwèt</span>
                        </div>
                        <div class="cart-actions">
                            <div class="cart-total" id="cart-total-display">0 Gdes</div>
                            <button onclick="processFinalTicket()" class="print-btn" id="print-cart-btn">
                                <i class="fas fa-print"></i> Enprime Fich
                            </button>
                        </div>
                    </div>
                    <div class="cart-list" id="cart-display">
                        <!-- Cart items will be inserted here -->
                    </div>
                    
                    <div id="cart-summary" style="display: none;">
                        <div class="total-row">
                            <span>Total pou peye:</span>
                            <span id="total-amount">0</span><span> Gdes</span>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Screen 3: History -->
            <section id="history-screen" class="screen">
                <div style="padding: 20px;">
                    <h2 class="section-title">Istorik Tikè</h2>
                    <div class="history-list" id="history-container">
                        <!-- History items will be inserted here -->
                    </div>
                </div>
            </section>

            <!-- Screen 4: Reports -->
            <section id="reports-screen" class="screen">
                <div style="padding: 20px;">
                    <h2 class="section-title">Rapò Jodi a</h2>
                    <div class="report-card">
                        <div class="report-row">
                            <span>Total Tikè:</span>
                            <span class="val" id="total-tickets">0</span>
                        </div>
                        <div class="report-row">
                            <span>Total Pari:</span>
                            <span class="val" id="total-bets">0 Gdes</span>
                        </div>
                        <div class="report-row">
                            <span>Total Ganyen:</span>
                            <span class="val" id="total-wins">0 Gdes</span>
                        </div>
                        <div class="report-row">
                            <span>Pèdi:</span>
                            <span class="val" id="total-loss">0 Gdes</span>
                        </div>
                        <div class="report-row total">
                            <span>Balans:</span>
                            <span class="val" id="balance">0 Gdes</span>
                        </div>
                    </div>

                    <div class="report-card">
                        <h3 style="margin-bottom: 15px;">Detay pa tiraj</h3>
                        <div id="game-breakdown">
                            <!-- Game breakdown will be inserted here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Screen 5: Winners -->
            <section id="winners-screen" class="screen">
                <div style="padding: 20px;">
                    <h2 class="section-title">Jere Ganyen</h2>
                    
                    <div class="agent-funds">
                        <div>Fonds Ajan</div>
                        <div class="funds-amount" id="agent-funds">10,000 Gdes</div>
                        <button onclick="openAddFundsModal()" class="add-funds-btn">
                            <i class="fas fa-plus-circle"></i> Ajoute Fonds
                        </button>
                    </div>

                    <div class="winners-summary">
                        <h3 style="margin-bottom: 15px;">Rekapitilatif Tiraj</h3>
                        <div class="summary-row">
                            <span>Total Vann:</span>
                            <span class="val">5,000 Gdes</span>
                        </div>
                        <div class="summary-row">
                            <span>Total Ganyen:</span>
                            <span class="val">1,500 Gdes</span>
                        </div>
                        <div class="summary-row total">
                            <span>Pwòfi/Pèt:</span>
                            <span class="val profit" id="profit-loss">+3,500 Gdes</span>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 15px; margin-top: 30px;">Tikè Ganyen yo</h3>
                    <div id="winners-container">
                        <!-- Winning tickets will be inserted here -->
                        <div class="empty-msg">Pa gen tikè ganyen pou kounye a</div>
                    </div>
                </div>
            </section>
        </main>

        <div id="winner-overlay" class="modal-overlay">
            <div class="winner-modal">
                <i class="fas fa-trophy trophy-icon"></i>
                <h2>OU GENYEN !</h2>
                <div id="winner-details"></div>
                <button onclick="closeWinnerModal()" class="btn-close">OK</button>
            </div>
        </div>
        
        <div id="funds-overlay" class="modal-overlay">
            <div class="funds-modal">
                <h2>Ajoute Fonds</h2>
                <p style="margin: 15px 0; color: var(--text-dim);">Antre montan an pou ajoute nan fonds ou.</p>
                <input type="number" id="funds-amount" class="modal-input" placeholder="Montan an Gdes" min="0">
                <p style="margin: 10px 0; color: var(--text-dim); font-size: 0.9rem;">Supervizè ap konfime tranzaksyon an.</p>
                <div class="modal-buttons">
                    <button onclick="addFunds()" class="modal-btn confirm">Konfime</button>
                    <button onclick="closeFundsModal()" class="modal-btn cancel">Anile</button>
                </div>
            </div>
        </div>
        
        <div id="lottery-config" class="lottery-config">
            <div class="config-modal">
                <h2>Konfigirasyon Lotri</h2>
                <div class="config-item">
                    <label class="config-label">Non Lotri:</label>
                    <input type="text" id="config-lottery-name" class="config-input" value="LOTATO PRO">
                </div>
                <div class="config-item">
                    <label class="config-label">URL Logo:</label>
                    <input type="text" id="config-logo-url" class="config-input" placeholder="https://example.com/logo.png">
                </div>
                <div class="config-item">
                    <label class="config-label">Adrès:</label>
                    <input type="text" id="config-address" class="config-input" placeholder="Adrès biznis la">
                </div>
                <div class="config-item">
                    <label class="config-label">Telefòn:</label>
                    <input type="text" id="config-phone" class="config-input" placeholder="+509XXXXXXXX">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveLotteryConfig()" style="flex: 1; padding: 12px; background: var(--success); color: black; border: none; border-radius: 12px; font-weight: bold;">Sove</button>
                    <button onclick="closeLotteryConfig()" style="flex: 1; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 12px; font-weight: bold;">Fèmen</button>
                </div>
            </div>
        </div>

        <nav class="nav-bar">
            <a href="#" class="nav-item active" onclick="switchTab('home')">
                <i class="fas fa-dice"></i><span>Jwèt</span>
            </a>
            <a href="#" class="nav-item" onclick="switchTab('history')">
                <i class="fas fa-receipt"></i><span>Istorik</span>
            </a>
            <a href="#" class="nav-item" onclick="switchTab('reports')">
                <i class="fas fa-chart-line"></i><span>Rapò</span>
            </a>
            <a href="#" class="nav-item" onclick="switchTab('winners')">
                <i class="fas fa-trophy"></i><span>Ganyen</span>
            </a>
        </nav>
    </div>

    <script>
        // Configuration de l'API
        const API_CONFIG = {
            BASE_URL: 'http://localhost:3000/api', // À changer pour votre serveur
            ENDPOINTS: {
                SAVE_TICKET: '/tickets/save',
                GET_TICKETS: '/tickets',
                GET_REPORTS: '/reports',
                SAVE_AGENT: '/agent/save',
                CHECK_DRAW_STATUS: '/draws/status',
                SAVE_WINNERS: '/winners/save',
                GET_WINNERS: '/winners',
                UPDATE_FUNDS: '/agent/funds'
            }
        };

        const CONFIG = {
            CURRENCY: 'Gdes',
            GAMING_RULES: {
                BORLETTE: { lot1: 60, lot2: 20, lot3: 10 },
                LOTTO3: 500,
                LOTTO4: 1000,
                LOTTO5: 5000,
                MARIAGE: 1000,
                AUTO_MARRIAGE: 1000,
                AUTO_LOTTO4: 1000,
                AUTO_LOTTO5: 5000
            },
            DRAWS: [
                { id: 'mia_matin', name: 'Miami Matin', time: '13:30', color: 'var(--miami)' },
                { id: 'mia_soir', name: 'Miami Soir', time: '21:50', color: 'var(--miami)' },
                { id: 'ny_matin', name: 'New York Matin', time: '14:30', color: 'var(--newyork)' },
                { id: 'ny_soir', name: 'New York Soir', time: '20:00', color: 'var(--newyork)' },
                { id: 'ga_matin', name: 'Georgia Matin', time: '12:30', color: 'var(--georgia)' },
                { id: 'ga_soir', name: 'Georgia Soir', time: '19:00', color: 'var(--georgia)' },
                { id: 'tx_matin', name: 'Texas Matin', time: '11:30', color: 'var(--texas)' },
                { id: 'tx_soir', name: 'Texas Soir', time: '18:30', color: 'var(--texas)' },
                { id: 'tn_matin', name: 'Tunisia Matin', time: '10:00', color: 'var(--tunisia)' },
                { id: 'tn_soir', name: 'Tunisia Soir', time: '17:00', color: 'var(--tunisia)' }
            ],
            LOTTERY_NAME: 'LOTATO PRO',
            LOTTERY_LOGO: '',
            LOTTERY_ADDRESS: '',
            LOTTERY_PHONE: ''
        };

        let APP_STATE = {
            selectedDraw: 'mia_matin',
            selectedDraws: ['mia_matin'],
            multiDrawMode: false,
            selectedGame: 'borlette',
            currentCart: [],
            ticketsHistory: [],
            winningTickets: [],
            lotto4Options: [true, true, true],
            lotto5Options: [true, true, true],
            showNumericChips: false,
            showLottoGames: false,
            showSpecialGames: false,
            currentTab: 'home',
            isDrawBlocked: false,
            agentId: 'agent-01',
            agentFunds: 10000,
            salesTotal: 0,
            winningsTotal: 0,
            profitLoss: 0
        };

        // Fonction pour vérifier si un tirage est bloqué (3 minutes avant)
        function isDrawBlocked(drawTime) {
            const now = new Date();
            const [hours, minutes] = drawTime.split(':').map(Number);
            
            const drawDate = new Date();
            drawDate.setHours(hours, minutes, 0, 0);
            
            // Bloquer 3 minutes avant
            const blockedTime = new Date(drawDate.getTime() - (3 * 60 * 1000));
            
            return now >= blockedTime && now < drawDate;
        }

        // Fonction pour vérifier le tirage sélectionné
        function checkSelectedDrawStatus() {
            const selectedDraw = CONFIG.DRAWS.find(d => d.id === APP_STATE.selectedDraw);
            if (!selectedDraw) return false;
            
            const blocked = isDrawBlocked(selectedDraw.time);
            APP_STATE.isDrawBlocked = blocked;
            
            const warningEl = document.getElementById('draw-blocked-warning');
            const addBetBtn = document.getElementById('add-bet-btn');
            
            if (blocked) {
                warningEl.style.display = 'flex';
                addBetBtn.disabled = true;
                addBetBtn.style.opacity = '0.5';
                addBetBtn.style.cursor = 'not-allowed';
                addBetBtn.innerHTML = '<i class="fas fa-ban"></i>';
            } else {
                warningEl.style.display = 'none';
                addBetBtn.disabled = false;
                addBetBtn.style.opacity = '1';
                addBetBtn.style.cursor = 'pointer';
                addBetBtn.innerHTML = '<i class="fas fa-plus"></i>';
            }
            
            return blocked;
        }

        const SpecialGames = {
            generateBOBets(amount) {
                const bets = [];
                for (let i = 0; i < 100; i++) {
                    const num = i.toString().padStart(2, '0');
                    if (num[0] === num[1]) {
                        bets.push({
                            id: Date.now() + Math.random(),
                            game: 'borlette',
                            number: num,
                            cleanNumber: num,
                            amount: amount,
                            drawId: APP_STATE.selectedDraw,
                            timestamp: new Date().toISOString(),
                            isAutoGenerated: true,
                            specialType: 'BO'
                        });
                    }
                }
                return bets;
            },

            generateNBets(digit, amount) {
                const bets = [];
                for (let i = 0; i < 100; i++) {
                    const num = i.toString().padStart(2, '0');
                    if (num[1] === digit.toString()) {
                        bets.push({
                            id: Date.now() + Math.random(),
                            game: 'borlette',
                            number: num,
                            cleanNumber: num,
                            amount: amount,
                            drawId: APP_STATE.selectedDraw,
                            timestamp: new Date().toISOString(),
                            isAutoGenerated: true,
                            specialType: `N${digit}`
                        });
                    }
                }
                return bets;
            },

            generateGRAPBets(amount) {
                const bets = [];
                for (let i = 0; i < 10; i++) {
                    const num = i.toString().repeat(3);
                    bets.push({
                        id: Date.now() + Math.random(),
                        game: 'lotto3',
                        number: num,
                        cleanNumber: num,
                        amount: amount,
                        drawId: APP_STATE.selectedDraw,
                        timestamp: new Date().toISOString(),
                        isAutoGenerated: true,
                        specialType: 'GRAP'
                    });
                }
                return bets;
            }
        };

        function setupInputAutoMove() {
            const numInput = document.getElementById('num-input');
            const amtInput = document.getElementById('amt-input');
            
            numInput.addEventListener('input', function(e) {
                const game = APP_STATE.selectedGame;
                let maxLength = 5;
                
                switch(game) {
                    case 'borlette': maxLength = 2; break;
                    case 'lotto3': maxLength = 3; break;
                    case 'lotto4': maxLength = 4; break;
                    case 'lotto5': maxLength = 5; break;
                    case 'mariage': maxLength = 4; break;
                    case 'auto_marriage': maxLength = 0; break;
                    case 'auto_lotto4': maxLength = 0; break;
                    case 'auto_lotto5': maxLength = 0; break;
                    case 'bo': maxLength = 0; break;
                    case 'grap': maxLength = 0; break;
                }
                
                if (game.startsWith('n')) {
                    maxLength = 0;
                }
                
                if (this.value.length >= maxLength && maxLength > 0) {
                    amtInput.focus();
                    amtInput.select();
                }
                
                if (game === 'lotto4' && this.value.length === 4) {
                    this.value = this.value.replace(/(\d{2})(\d{2})/, '$1-$2');
                } else if (game === 'lotto5' && this.value.length === 5) {
                    this.value = this.value.replace(/(\d{3})(\d{2})/, '$1-$2');
                } else if (game === 'mariage' && this.value.length === 4) {
                    this.value = this.value.replace(/(\d{2})(\d{2})/, '$1&$2');
                }
            });
            
            amtInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    CartManager.addBet();
                }
            });
        }

        const GameEngine = {
            validateEntry(type, num) {
                const cleanNum = num.toString().replace(/[-&]/g, '');
                const n = cleanNum;
                
                switch(type) {
                    case 'borlette': return n.length === 2;
                    case 'lotto3':   return n.length === 3;
                    case 'lotto4':   return n.length === 4;
                    case 'lotto5':   return n.length === 5;
                    case 'mariage':  return n.length === 4;
                    case 'auto_marriage': return true;
                    case 'auto_lotto4': return true;
                    case 'auto_lotto5': return true;
                    case 'bo': return true;
                    case 'grap': return true;
                    default: 
                        if (type.startsWith('n')) return true;
                        return false;
                }
            },

            getCleanNumber(num) {
                return num.toString().replace(/[-&]/g, '');
            },

            generateAutoMarriageBets(amount) {
                const borletteNumbers = APP_STATE.currentCart
                    .filter(item => item.game === 'borlette' && this.getCleanNumber(item.number).length === 2)
                    .map(item => this.getCleanNumber(item.number));

                const uniqueNumbers = [...new Set(borletteNumbers)];
                const autoBets = [];
                
                for (let i = 0; i < uniqueNumbers.length; i++) {
                    for (let j = i + 1; j < uniqueNumbers.length; j++) {
                        autoBets.push({
                            id: Date.now() + Math.random(),
                            game: 'auto_marriage',
                            number: uniqueNumbers[i] + '&' + uniqueNumbers[j],
                            cleanNumber: uniqueNumbers[i] + uniqueNumbers[j],
                            amount: amount,
                            drawId: APP_STATE.selectedDraw,
                            timestamp: new Date().toISOString(),
                            isAutoGenerated: true
                        });
                    }
                }
                
                return autoBets;
            },

            generateAutoLotto4Bets(amount) {
                const borletteNumbers = APP_STATE.currentCart
                    .filter(item => item.game === 'borlette' && this.getCleanNumber(item.number).length === 2)
                    .map(item => this.getCleanNumber(item.number));

                const uniqueNumbers = [...new Set(borletteNumbers)];
                const autoBets = [];
                
                for (let i = 0; i < uniqueNumbers.length; i++) {
                    for (let j = 0; j < uniqueNumbers.length; j++) {
                        if (i !== j) {
                            autoBets.push({
                                id: Date.now() + Math.random(),
                                game: 'auto_lotto4',
                                number: uniqueNumbers[i] + '-' + uniqueNumbers[j],
                                cleanNumber: uniqueNumbers[i] + uniqueNumbers[j],
                                amount: amount,
                                drawId: APP_STATE.selectedDraw,
                                timestamp: new Date().toISOString(),
                                isAutoGenerated: true
                            });
                        }
                    }
                }
                
                return autoBets;
            },

            generateAutoLotto5Bets(amount) {
                const lotto3Numbers = APP_STATE.currentCart
                    .filter(item => item.game === 'lotto3' && this.getCleanNumber(item.number).length === 3)
                    .map(item => this.getCleanNumber(item.number));

                const uniqueNumbers = [...new Set(lotto3Numbers)];
                const autoBets = [];
                
                for (let i = 0; i < uniqueNumbers.length; i++) {
                    for (let j = 0; j < uniqueNumbers.length; j++) {
                        if (i !== j) {
                            autoBets.push({
                                id: Date.now() + Math.random(),
                                game: 'auto_lotto5',
                                number: uniqueNumbers[i] + '-' + uniqueNumbers[j].slice(-2),
                                cleanNumber: uniqueNumbers[i] + uniqueNumbers[j].slice(-2),
                                amount: amount,
                                drawId: APP_STATE.selectedDraw,
                                timestamp: new Date().toISOString(),
                                isAutoGenerated: true
                            });
                        }
                    }
                }
                
                return autoBets;
            }
        };

        // Fonctions API
        const APIService = {
            async saveTicket(ticket) {
                try {
                    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.SAVE_TICKET}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...ticket,
                            agentId: APP_STATE.agentId,
                            date: new Date().toISOString()
                        })
                    });
                    
                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Erreur sauvegarde ticket:', error);
                    throw error;
                }
            },

            async getTickets() {
                try {
                    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.GET_TICKETS}?agentId=${APP_STATE.agentId}`);
                    
                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    const data = await response.json();
                    APP_STATE.ticketsHistory = data.tickets || [];
                    return data;
                } catch (error) {
                    console.error('Erreur récupération tickets:', error);
                    return { tickets: [] };
                }
            },

            async getReports() {
                try {
                    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.GET_REPORTS}?agentId=${APP_STATE.agentId}`);
                    
                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Erreur récupération rapports:', error);
                    return { totalTickets: 0, totalBets: 0, totalWins: 0, totalLoss: 0, balance: 0 };
                }
            },

            async saveAgentConfig(config) {
                try {
                    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.SAVE_AGENT}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            agentId: APP_STATE.agentId,
                            ...config
                        })
                    });
                    
                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    return await response.json();
                } catch (error) {
                    console.error('Erreur sauvegarde agent:', error);
                    throw error;
                }
            },
            
            async getWinningTickets() {
                try {
                    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.GET_WINNERS}?agentId=${APP_STATE.agentId}`);
                    
                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    const data = await response.json();
                    APP_STATE.winningTickets = data.winners || [];
                    return data;
                } catch (error) {
                    console.error('Erreur récupération gagnants:', error);
                    return { winners: [] };
                }
            },
            
            async updateAgentFunds(amount) {
                try {
                    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.UPDATE_FUNDS}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            agentId: APP_STATE.agentId,
                            amount: amount,
                            type: 'add'
                        })
                    });
                    
                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    const data = await response.json();
                    APP_STATE.agentFunds = data.newBalance;
                    return data;
                } catch (error) {
                    console.error('Erreur mise à jour fonds:', error);
                    throw error;
                }
            }
        };

        function switchTab(tabName) {
            APP_STATE.currentTab = tabName;
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            let screenId = '';
            switch(tabName) {
                case 'home':
                    screenId = 'draw-selection-screen';
                    document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                    break;
                case 'history':
                    screenId = 'history-screen';
                    document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                    loadHistory();
                    break;
                case 'reports':
                    screenId = 'reports-screen';
                    document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                    loadReports();
                    break;
                case 'winners':
                    screenId = 'winners-screen';
                    document.querySelector('.nav-item:nth-child(4)').classList.add('active');
                    loadWinners();
                    break;
            }
            
            if (screenId) {
                document.getElementById(screenId).classList.add('active');
            }
        }

        async function loadHistory() {
            try {
                const container = document.getElementById('history-container');
                container.innerHTML = '<div class="empty-msg">Chajman...</div>';
                
                await APIService.getTickets();
                renderHistory();
            } catch (error) {
                document.getElementById('history-container').innerHTML = 
                    '<div class="empty-msg">Erè chajman istorik</div>';
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            
            if (APP_STATE.ticketsHistory.length === 0) {
                container.innerHTML = '<div class="empty-msg">Pa gen tikè nan istorik</div>';
                return;
            }
            
            container.innerHTML = APP_STATE.ticketsHistory.map(ticket => {
                let status = '';
                let statusClass = '';
                
                if (ticket.checked) {
                    const totalBet = ticket.bets.reduce((sum, bet) => sum + bet.amount, 0);
                    const hasWin = ticket.bets.some(bet => bet.gain > 0);
                    
                    if (hasWin) {
                        status = 'GANYEN';
                        statusClass = 'badge-win';
                    } else {
                        status = 'PÈDI';
                        statusClass = 'badge-lost';
                    }
                } else {
                    status = 'AP TANN';
                    statusClass = 'badge-wait';
                }
                
                return `
                    <div class="history-card">
                        <div class="card-header">
                            <span>#${ticket.id}</span>
                            <span>${new Date(ticket.date).toLocaleDateString('fr-FR')}</span>
                        </div>
                        <div>
                            <p><strong>Tiraj:</strong> ${ticket.drawName}</p>
                            <p><strong>Total:</strong> ${ticket.total} Gdes</p>
                            <p><strong>Nimewo:</strong> ${ticket.bets.length}</p>
                        </div>
                        <div class="card-footer">
                            <span class="badge ${statusClass}">${status}</span>
                            <button class="btn-small" onclick="viewTicketDetails('${ticket._id || ticket.id}')">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadReports() {
            try {
                const reports = await APIService.getReports();
                
                document.getElementById('total-tickets').textContent = reports.totalTickets || 0;
                document.getElementById('total-bets').textContent = (reports.totalBets || 0) + ' Gdes';
                document.getElementById('total-wins').textContent = (reports.totalWins || 0) + ' Gdes';
                document.getElementById('total-loss').textContent = (reports.totalLoss || 0) + ' Gdes';
                document.getElementById('balance').textContent = (reports.balance || 0) + ' Gdes';
                document.getElementById('balance').style.color = (reports.balance >= 0) ? 'var(--success)' : 'var(--danger)';
                
                // Game breakdown - à adapter selon votre API
                const breakdownContainer = document.getElementById('game-breakdown');
                if (reports.breakdown) {
                    breakdownContainer.innerHTML = Object.entries(reports.breakdown).map(([game, data]) => `
                        <div class="report-row">
                            <span>${game.toUpperCase()}:</span>
                            <span class="val">${data.count} jwèt (${data.amount} Gdes)</span>
                        </div>
                    `).join('');
                } else {
                    breakdownContainer.innerHTML = '<div class="empty-msg">Pa gen done detay</div>';
                }
            } catch (error) {
                console.error('Erreur chargement rapports:', error);
            }
        }
        
        async function loadWinners() {
            try {
                await APIService.getWinningTickets();
                updateWinnersDisplay();
                calculateProfitLoss();
            } catch (error) {
                console.error('Erreur chargement gagnants:', error);
            }
        }
        
        function updateWinnersDisplay() {
            const container = document.getElementById('winners-container');
            const fundsDisplay = document.getElementById('agent-funds');
            
            // Mettre à jour les fonds
            fundsDisplay.textContent = APP_STATE.agentFunds.toLocaleString() + ' Gdes';
            
            if (APP_STATE.winningTickets.length === 0) {
                container.innerHTML = '<div class="empty-msg">Pa gen tikè ganyen pou kounye a</div>';
                return;
            }
            
            container.innerHTML = APP_STATE.winningTickets.map(ticket => {
                const canPay = APP_STATE.agentFunds >= ticket.winningAmount;
                const isPaid = ticket.paid || false;
                
                return `
                    <div class="winner-ticket">
                        <div class="winner-header">
                            <div>
                                <strong>Tikè #${ticket.ticketId}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-dim);">${ticket.drawName} - ${new Date(ticket.date).toLocaleDateString('fr-FR')}</div>
                            </div>
                            <div style="font-weight: bold; color: var(--success);">
                                ${ticket.winningAmount.toLocaleString()} Gdes
                            </div>
                        </div>
                        <div>
                            <p><strong>Nimewo Ganyen:</strong> ${ticket.winningNumber}</p>
                            <p><strong>Jwèt:</strong> ${ticket.gameType.toUpperCase()}</p>
                            <p><strong>Kliyan:</strong> ${ticket.customerName || 'Pa defini'}</p>
                        </div>
                        <div class="winner-actions">
                            ${isPaid ? 
                                '<button class="btn-paid" disabled><i class="fas fa-check"></i> Peye</button>' :
                                canPay ?
                                `<button class="btn-pay" onclick="payWinner('${ticket.id}')">
                                    <i class="fas fa-money-bill-wave"></i> Peye
                                </button>` :
                                `<button class="btn-need-funds" onclick="requestSupervisorFunds(${ticket.winningAmount})">
                                    <i class="fas fa-exclamation-triangle"></i> Bezwen Fonds
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function calculateProfitLoss() {
            // Calculer le total des ventes
            const totalSales = APP_STATE.ticketsHistory.reduce((sum, ticket) => {
                return sum + (ticket.total || 0);
            }, 0);
            
            // Calculer le total des gains
            const totalWinnings = APP_STATE.winningTickets.reduce((sum, ticket) => {
                return sum + (ticket.winningAmount || 0);
            }, 0);
            
            // Calculer profit/perte
            const profitLoss = totalSales - totalWinnings;
            
            // Mettre à jour l'état
            APP_STATE.salesTotal = totalSales;
            APP_STATE.winningsTotal = totalWinnings;
            APP_STATE.profitLoss = profitLoss;
            
            // Mettre à jour l'affichage
            document.getElementById('profit-loss').textContent = 
                (profitLoss >= 0 ? '+' : '') + profitLoss.toLocaleString() + ' Gdes';
            
            document.getElementById('profit-loss').className = profitLoss >= 0 ? 'val profit' : 'val loss';
            
            // Mettre à jour les détails
            const summaryContainer = document.querySelector('.winners-summary');
            if (summaryContainer) {
                summaryContainer.querySelectorAll('.summary-row')[0].querySelector('.val').textContent = 
                    totalSales.toLocaleString() + ' Gdes';
                summaryContainer.querySelectorAll('.summary-row')[1].querySelector('.val').textContent = 
                    totalWinnings.toLocaleString() + ' Gdes';
            }
        }
        
        async function payWinner(ticketId) {
            const ticket = APP_STATE.winningTickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            if (APP_STATE.agentFunds < ticket.winningAmount) {
                alert("Ou pa gen ase fonds pou peye tikè sa a. Tanpri ajoute fonds oswa mande vizè.");
                return;
            }
            
            if (confirm(`Èske ou vle peye ${ticket.winningAmount} Gdes pou Tikè #${ticket.ticketId}?`)) {
                try {
                    // Simuler le paiement
                    APP_STATE.agentFunds -= ticket.winningAmount;
                    ticket.paid = true;
                    
                    // Mettre à jour l'affichage
                    updateWinnersDisplay();
                    calculateProfitLoss();
                    
                    alert(`Tikè #${ticket.ticketId} peye siksè!`);
                    
                    // Ici vous devriez appeler l'API pour mettre à jour le statut du ticket
                    // await APIService.markTicketAsPaid(ticketId);
                } catch (error) {
                    console.error('Erreur paiement:', error);
                    alert('Erè nan peman an');
                }
            }
        }
        
        function requestSupervisorFunds(amountNeeded) {
            const needed = amountNeeded - APP_STATE.agentFunds;
            if (needed > 0) {
                alert(`Ou bezwen ${needed.toLocaleString()} Gdes plis nan fonds ou. Tanpri kontakte vizè a pou rechargeman.`);
                openAddFundsModal();
            }
        }

        function viewTicketDetails(ticketId) {
            const ticket = APP_STATE.ticketsHistory.find(t => t._id === ticketId || t.id === ticketId);
            if (!ticket) return;
            
            let details = `
                <h3>Detay Tikè #${ticket.id}</h3>
                <p><strong>Tiraj:</strong> ${ticket.drawName}</p>
                <p><strong>Dat:</strong> ${new Date(ticket.date).toLocaleString('fr-FR')}</p>
                <p><strong>Total:</strong> ${ticket.total} Gdes</p>
                <hr>
                <h4>Paray yo:</h4>
            `;
            
            ticket.bets.forEach(bet => {
                let gameName = bet.game.toUpperCase();
                if (bet.specialType) gameName = bet.specialType;
                details += `<p>${gameName} ${bet.number} - ${bet.amount} Gdes ${bet.gain ? `(Ganyen: ${bet.gain} Gdes)` : ''}</p>`;
            });
            
            alert(details);
        }

        function toggleMultiDrawMode() {
            APP_STATE.multiDrawMode = !APP_STATE.multiDrawMode;
            const btn = document.getElementById('multi-draw-btn');
            const multiContainer = document.getElementById('multi-draw-container');
            const continueBtn = document.getElementById('multi-draw-continue');
            const drawGrid = document.getElementById('draws-container');
            
            if (APP_STATE.multiDrawMode) {
                btn.innerHTML = '<i class="fas fa-times"></i> Sispann Plizyè Tiraj';
                btn.style.background = 'rgba(255, 77, 77, 0.2)';
                btn.style.borderColor = 'var(--danger)';
                btn.style.color = 'var(--danger)';
                multiContainer.style.display = 'flex';
                continueBtn.style.display = 'block';
                drawGrid.style.display = 'none';
                renderMultiDrawSelector();
            } else {
                btn.innerHTML = '<i class="fas fa-layer-group"></i> Plizyè Tiraj';
                btn.style.background = 'rgba(0, 212, 255, 0.2)';
                btn.style.borderColor = 'var(--secondary)';
                btn.style.color = 'var(--secondary)';
                multiContainer.style.display = 'none';
                continueBtn.style.display = 'none';
                drawGrid.style.display = 'grid';
            }
        }

        function renderMultiDrawSelector() {
            const container = document.getElementById('multi-draw-container');
            container.innerHTML = CONFIG.DRAWS.map(draw => {
                const blocked = isDrawBlocked(draw.time);
                return `
                    <input type="checkbox" class="multi-draw-checkbox" id="multi-${draw.id}" 
                           value="${draw.id}" ${APP_STATE.selectedDraws.includes(draw.id) && !blocked ? 'checked' : ''}
                           ${blocked ? 'disabled' : ''}
                           onchange="toggleMultiDrawSelection('${draw.id}')">
                    <label for="multi-${draw.id}" class="multi-draw-label" style="border-left: 3px solid ${draw.color}; ${blocked ? 'opacity: 0.5;' : ''}">
                        ${draw.name} ${blocked ? '(BLOKÉ)' : ''}
                    </label>
                `;
            }).join('');
        }

        function toggleMultiDrawSelection(drawId) {
            const checkbox = document.getElementById(`multi-${drawId}`);
            if (checkbox.checked) {
                if (!APP_STATE.selectedDraws.includes(drawId)) {
                    APP_STATE.selectedDraws.push(drawId);
                }
            } else {
                APP_STATE.selectedDraws = APP_STATE.selectedDraws.filter(id => id !== drawId);
            }
            
            document.getElementById('selected-draws-count').textContent = APP_STATE.selectedDraws.length;
        }

        function continueToBettingWithMultiDraw() {
            if (APP_STATE.selectedDraws.length === 0) {
                alert("Tanpri chwazi omwen yon tiraj");
                return;
            }
            
            APP_STATE.selectedDraw = APP_STATE.selectedDraws[0];
            const draw = CONFIG.DRAWS.find(d => d.id === APP_STATE.selectedDraw);
            document.getElementById('current-draw-title').textContent = draw.name;
            
            const indicator = document.getElementById('multi-draw-indicator');
            indicator.style.display = 'block';
            document.getElementById('selected-draws-count').textContent = APP_STATE.selectedDraws.length;
            
            document.getElementById('draw-selection-screen').classList.remove('active');
            document.getElementById('betting-screen').classList.add('active');
            document.querySelector('.back-button').style.display = 'flex';
            
            updateGameSelector();
            checkSelectedDrawStatus();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('live-clock').innerText = now.toLocaleTimeString('fr-FR');
            
            // Vérifier le statut du tirage toutes les 30 secondes
            if (APP_STATE.currentTab === 'home' || APP_STATE.currentTab === 'betting') {
                checkSelectedDrawStatus();
            }
        }

        function renderDraws() {
            const container = document.getElementById('draws-container');
            container.innerHTML = CONFIG.DRAWS.map(draw => {
                const blocked = isDrawBlocked(draw.time);
                const isActive = APP_STATE.selectedDraw === draw.id && !blocked;
                
                return `
                    <div class="draw-card ${isActive ? 'active' : ''} ${blocked ? 'blocked' : ''}" 
                         onclick="${blocked ? '' : `selectDraw('${draw.id}')`}" 
                         style="--draw-color: ${draw.color}">
                        <span class="draw-name">${draw.name}</span>
                        <span class="draw-time"><i class="far fa-clock"></i> ${draw.time}</span>
                        ${blocked ? '<span class="blocked-badge">BLOKÉ</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        function selectDraw(id) {
            if (APP_STATE.multiDrawMode) return;
            
            const draw = CONFIG.DRAWS.find(d => d.id === id);
            if (isDrawBlocked(draw.time)) {
                alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute paray.");
                return;
            }
            
            APP_STATE.selectedDraw = id;
            APP_STATE.selectedDraws = [id];
            document.getElementById('current-draw-title').textContent = draw.name;
            
            document.getElementById('multi-draw-indicator').style.display = 'none';
            
            document.getElementById('draw-selection-screen').classList.remove('active');
            document.getElementById('betting-screen').classList.add('active');
            document.querySelector('.back-button').style.display = 'flex';
            
            updateGameSelector();
            checkSelectedDrawStatus();
        }

        function goBackToDraws() {
            document.getElementById('betting-screen').classList.remove('active');
            document.getElementById('draw-selection-screen').classList.add('active');
            document.querySelector('.back-button').style.display = 'none';
            
            APP_STATE.multiDrawMode = false;
            const btn = document.getElementById('multi-draw-btn');
            btn.innerHTML = '<i class="fas fa-layer-group"></i> Plizyè Tiraj';
            btn.style.background = 'rgba(0, 212, 255, 0.2)';
            btn.style.borderColor = 'var(--secondary)';
            btn.style.color = 'var(--secondary)';
            
            document.getElementById('multi-draw-container').style.display = 'none';
            document.getElementById('multi-draw-continue').style.display = 'none';
            document.getElementById('draws-container').style.display = 'grid';
            
            renderDraws();
        }

        function toggleNumericChips() {
            APP_STATE.showNumericChips = !APP_STATE.showNumericChips;
            const container = document.getElementById('numeric-chips');
            const btn = document.getElementById('toggle-nx-btn');
            
            if (APP_STATE.showNumericChips) {
                container.classList.add('visible');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> NX';
            } else {
                container.classList.remove('visible');
                btn.classList.remove('active');
                btn.innerHTML = 'NX';
            }
            
            APP_STATE.showLottoGames = false;
            APP_STATE.showSpecialGames = false;
            document.getElementById('lotto-games').classList.remove('visible');
            document.getElementById('special-games').classList.remove('visible');
            
            document.querySelectorAll('#game-types .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('#game-types .chip[data-game="borlette"]').classList.add('active');
        }

        function toggleLottoOption(gameType, optionIndex) {
            if (gameType === 4) {
                APP_STATE.lotto4Options[optionIndex - 1] = !APP_STATE.lotto4Options[optionIndex - 1];
            } else if (gameType === 5) {
                APP_STATE.lotto5Options[optionIndex - 1] = !APP_STATE.lotto5Options[optionIndex - 1];
            }
            
            const optionChip = document.querySelector(`#lotto${gameType}-options .option-chip[data-option="${optionIndex}"]`);
            if (optionChip) {
                optionChip.classList.toggle('active');
                optionChip.classList.add('animate-bounce');
                setTimeout(() => {
                    optionChip.classList.remove('animate-bounce');
                }, 500);
            }
        }

        function selectGame(game) {
            if (APP_STATE.isDrawBlocked) {
                alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute plis paray.");
                return;
            }
            
            APP_STATE.selectedGame = game;
            const input = document.getElementById('num-input');
            
            document.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.sub-game-btn').forEach(b => b.classList.remove('active'));
            
            if (game.startsWith('n')) {
                document.querySelector(`.numeric-chip[data-game="${game}"]`).classList.add('active');
            }
            
            document.querySelector('#game-types .chip[data-game="borlette"]').classList.add('active');
            
            const placeholderMap = {
                'borlette': '00',
                'lotto3': '000',
                'lotto4': '0000',
                'lotto5': '00000',
                'mariage': '0000',
                'auto_marriage': 'Auto',
                'auto_lotto4': 'Auto',
                'auto_lotto5': 'Auto',
                'bo': 'Auto',
                'grap': 'Auto'
            };
            
            input.placeholder = placeholderMap[game] || '00';
            
            if (game.includes('auto') || game === 'bo' || game === 'grap' || game.startsWith('n')) {
                input.disabled = true;
                input.value = '';
                input.placeholder = 'Auto-genere';
            } else {
                input.disabled = false;
                input.focus();
            }
            
            const lotto4Options = document.getElementById('lotto4-options');
            const lotto5Options = document.getElementById('lotto5-options');
            
            if (game === 'lotto4' || game === 'auto_lotto4') {
                lotto4Options.classList.add('visible');
                lotto5Options.classList.remove('visible');
            } else if (game === 'lotto5' || game === 'auto_lotto5') {
                lotto5Options.classList.add('visible');
                lotto4Options.classList.remove('visible');
            } else {
                lotto4Options.classList.remove('visible');
                lotto5Options.classList.remove('visible');
            }
        }

        function updateGameSelector() {
            const gameSelector = document.getElementById('game-types');
            gameSelector.innerHTML = `
                <button class="chip active" data-game="borlette" onclick="selectMainGame('borlette')">Borlette</button>
                <button class="chip" data-game="lotto" onclick="selectMainGame('lotto')">Lotto</button>
                <button class="chip" data-game="special" onclick="selectMainGame('special')">Jeux Spéciaux</button>
                <button class="chip" id="toggle-nx-btn" onclick="toggleNumericChips()">NX</button>
            `;
            
            document.querySelectorAll('.sub-game-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const game = this.getAttribute('onclick').match(/selectGame\('(\w+)'\)/)[1];
                    selectGame(game);
                    this.classList.add('active');
                });
            });
            
            selectGame('borlette');
        }

        function selectMainGame(game) {
            APP_STATE.showNumericChips = false;
            document.getElementById('numeric-chips').classList.remove('visible');
            document.getElementById('toggle-nx-btn').classList.remove('active');
            document.getElementById('toggle-nx-btn').innerHTML = 'NX';
            
            document.querySelectorAll('#game-types .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`#game-types .chip[data-game="${game}"]`).classList.add('active');
            
            if (game === 'lotto') {
                APP_STATE.showLottoGames = !APP_STATE.showLottoGames;
                APP_STATE.showSpecialGames = false;
                
                if (APP_STATE.showLottoGames) {
                    document.getElementById('lotto-games').classList.add('visible');
                    document.getElementById('special-games').classList.remove('visible');
                } else {
                    document.getElementById('lotto-games').classList.remove('visible');
                }
            } else if (game === 'special') {
                APP_STATE.showSpecialGames = !APP_STATE.showSpecialGames;
                APP_STATE.showLottoGames = false;
                
                if (APP_STATE.showSpecialGames) {
                    document.getElementById('special-games').classList.add('visible');
                    document.getElementById('lotto-games').classList.remove('visible');
                } else {
                    document.getElementById('special-games').classList.remove('visible');
                }
            } else if (game === 'borlette') {
                APP_STATE.showLottoGames = false;
                APP_STATE.showSpecialGames = false;
                document.getElementById('lotto-games').classList.remove('visible');
                document.getElementById('special-games').classList.remove('visible');
                selectGame('borlette');
            }
        }

        const CartManager = {
            addBet() {
                if (APP_STATE.isDrawBlocked) {
                    alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute plis paray.");
                    return;
                }

                const numInput = document.getElementById('num-input');
                const amtInput = document.getElementById('amt-input');
                let num = numInput.value.trim();
                const amt = parseFloat(amtInput.value);

                if (isNaN(amt) || amt <= 0) {
                    alert("Tanpri antre yon montan ki valid");
                    return;
                }

                if (APP_STATE.selectedGame === 'bo') {
                    const boBets = SpecialGames.generateBOBets(amt);
                    
                    if (boBets.length === 0) {
                        alert("Pa gen boules paires pou ajoute");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        boBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${boBets.length * draws.length} boules paires ajoute nan panye`);
                    return;
                }

                if (APP_STATE.selectedGame.startsWith('n')) {
                    const digit = parseInt(APP_STATE.selectedGame[1]);
                    const nBets = SpecialGames.generateNBets(digit, amt);
                    
                    if (nBets.length === 0) {
                        alert("Pa gen boules pou ajoute");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        nBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${nBets.length * draws.length} boules (N${digit}) ajoute nan panye`);
                    return;
                }

                if (APP_STATE.selectedGame === 'grap') {
                    const grapBets = SpecialGames.generateGRAPBets(amt);
                    
                    if (grapBets.length === 0) {
                        alert("Pa gen boules grap pou ajoute");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        grapBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${grapBets.length * draws.length} boules grap ajoute nan panye`);
                    return;
                }

                if (APP_STATE.selectedGame.includes('auto')) {
                    if (isNaN(amt) || amt <= 0) {
                        alert("Tanpri antre yon montan ki valid");
                        return;
                    }

                    let autoBets = [];
                    if (APP_STATE.selectedGame === 'auto_marriage') {
                        autoBets = GameEngine.generateAutoMarriageBets(amt);
                    } else if (APP_STATE.selectedGame === 'auto_lotto4') {
                        autoBets = GameEngine.generateAutoLotto4Bets(amt);
                    } else if (APP_STATE.selectedGame === 'auto_lotto5') {
                        autoBets = GameEngine.generateAutoLotto5Bets(amt);
                    }
                    
                    if (autoBets.length === 0) {
                        alert("Pa gen nimewo nan panye pou kreye jwèt otomatik yo");
                        return;
                    }

                    const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                    
                    draws.forEach(drawId => {
                        autoBets.forEach(bet => {
                            const newBet = {
                                ...bet,
                                id: Date.now() + Math.random(),
                                drawId: drawId,
                                drawName: CONFIG.DRAWS.find(d => d.id === drawId).name
                            };
                            APP_STATE.currentCart.push(newBet);
                        });
                    });
                    
                    this.renderCart();
                    amtInput.value = '';
                    alert(`${autoBets.length * draws.length} jwèt otomatik ajoute nan panye`);
                    return;
                }

                if (!GameEngine.validateEntry(APP_STATE.selectedGame, num)) {
                    alert("Nimewo sa pa bon pou " + APP_STATE.selectedGame);
                    return;
                }

                num = GameEngine.getCleanNumber(num);
                
                let displayNum = num;
                if (APP_STATE.selectedGame === 'lotto4' && num.length === 4) {
                    displayNum = num.slice(0, 2) + '-' + num.slice(2, 4);
                } else if (APP_STATE.selectedGame === 'lotto5' && num.length === 5) {
                    displayNum = num.slice(0, 3) + '-' + num.slice(3, 5);
                } else if (APP_STATE.selectedGame === 'mariage' && num.length === 4) {
                    displayNum = num.slice(0, 2) + '&' + num.slice(2, 4);
                }

                const draws = APP_STATE.multiDrawMode ? APP_STATE.selectedDraws : [APP_STATE.selectedDraw];
                
                draws.forEach(drawId => {
                    const bet = {
                        id: Date.now() + Math.random(),
                        game: APP_STATE.selectedGame,
                        number: displayNum,
                        cleanNumber: num,
                        amount: amt,
                        drawId: drawId,
                        drawName: CONFIG.DRAWS.find(d => d.id === drawId).name,
                        timestamp: new Date().toISOString(),
                        isAutoGenerated: false,
                        isSpecial: false
                    };

                    APP_STATE.currentCart.push(bet);
                });
                
                this.renderCart();
                
                numInput.value = '';
                amtInput.value = '';
                numInput.focus();
            },

            removeBet(id) {
                APP_STATE.currentCart = APP_STATE.currentCart.filter(item => item.id !== id);
                this.renderCart();
            },

            renderCart() {
                const display = document.getElementById('cart-display');
                const summary = document.getElementById('cart-summary');
                const totalDisplay = document.getElementById('total-amount');
                const countDisplay = document.getElementById('items-count');
                const cartTotalDisplay = document.getElementById('cart-total-display');

                if (APP_STATE.currentCart.length === 0) {
                    display.innerHTML = '<div class="empty-msg">Pa gen paray ankò</div>';
                    summary.style.display = 'none';
                    countDisplay.innerText = "0 jwèt";
                    cartTotalDisplay.innerText = "0 Gdes";
                    return;
                }

                let total = 0;
                display.innerHTML = APP_STATE.currentCart.map(item => {
                    total += item.amount;
                    let gameName = '';
                    
                    if (item.isAutoGenerated && item.specialType) {
                        gameName = item.specialType.toUpperCase();
                    } else if (item.isAutoGenerated) {
                        gameName = `${item.game.replace('_', ' ').toUpperCase()}*`;
                    } else {
                        gameName = item.game.toUpperCase();
                    }
                    
                    const drawName = APP_STATE.multiDrawMode ? item.drawName : '';
                    
                    return `
                        <div class="cart-item animate-fade">
                            <div class="item-info">
                                <span class="item-game">${gameName} ${item.number}</span>
                                ${APP_STATE.multiDrawMode ? `<span style="font-size:0.8rem; color:var(--text-dim)">${drawName}</span>` : ''}
                            </div>
                            <div class="item-price">
                                <span>${item.amount} ${CONFIG.CURRENCY}</span>
                                <button onclick="CartManager.removeBet(${item.id})" style="background:none; border:none; color:var(--danger); cursor:pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                totalDisplay.innerText = total;
                countDisplay.innerText = APP_STATE.currentCart.length + " jwèt";
                cartTotalDisplay.innerText = total.toLocaleString() + " Gdes";
                summary.style.display = 'block';
                
                display.scrollTop = display.scrollHeight;
            }
        };

        async function processFinalTicket() {
            if (APP_STATE.currentCart.length === 0) {
                alert("Pa gen anyen nan panye an!");
                return;
            }

            if (APP_STATE.isDrawBlocked) {
                alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka enprime fich.");
                return;
            }

            const betsByDraw = {};
            APP_STATE.currentCart.forEach(bet => {
                if (!betsByDraw[bet.drawId]) {
                    betsByDraw[bet.drawId] = [];
                }
                betsByDraw[bet.drawId].push(bet);
            });

            const drawIds = Object.keys(betsByDraw);
            let tickets = [];
            
            try {
                for (const drawId of drawIds) {
                    const drawBets = betsByDraw[drawId];
                    const draw = CONFIG.DRAWS.find(d => d.id === drawId);
                    
                    const ticket = {
                        id: Math.floor(100000 + Math.random() * 900000),
                        agentId: APP_STATE.agentId,
                        agentName: document.getElementById('agent-name').textContent,
                        drawId: drawId,
                        drawName: draw.name,
                        bets: drawBets,
                        total: drawBets.reduce((sum, b) => sum + b.amount, 0),
                        date: new Date().toISOString(),
                        checked: false
                    };

                    // Sauvegarde dans MongoDB via API
                    const savedTicket = await APIService.saveTicket(ticket);
                    tickets.push(savedTicket);
                    
                    // Mise à jour de l'historique local
                    APP_STATE.ticketsHistory.unshift(savedTicket);
                }
                
                // Impression des tickets
                tickets.forEach(ticket => {
                    printThermalTicket(ticket);
                });
                
                // Réinitialisation du panier
                APP_STATE.currentCart = [];
                CartManager.renderCart();
                
                if (tickets.length === 1) {
                    alert("Fich sove ak siksè nan MongoDB! #" + tickets[0].id);
                } else {
                    alert(`${tickets.length} fich sove ak siksè nan MongoDB!`);
                }
                
                // Recalculer les profits/pertes
                calculateProfitLoss();
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                alert("Erè sou sèvè a. Fich la pa sove.");
            }
        }

        function printThermalTicket(ticket) {
            const printWindow = window.open('', '_blank', 'width=300,height=600');
            
            let betsHtml = ticket.bets.map(b => {
                let gameName = '';
                if (b.isAutoGenerated && b.specialType) {
                    gameName = b.specialType.toUpperCase();
                } else if (b.isAutoGenerated) {
                    gameName = `${b.game.replace('_', ' ').toUpperCase()}*`;
                } else {
                    gameName = b.game.toUpperCase();
                }
                
                return `
                    <div style="display:flex; justify-content:space-between; font-size:14px;">
                        <span>${gameName} ${b.number}</span>
                        <span>${b.amount}G</span>
                    </div>
                `;
            }).join('');

            const lotteryName = CONFIG.LOTTERY_NAME;
            const logoHtml = CONFIG.LOTTERY_LOGO ? 
                `<img src="${CONFIG.LOTTERY_LOGO}" style="max-width: 100px; margin: 10px auto; display: block;" alt="${lotteryName}">` : 
                '';
            const addressHtml = CONFIG.LOTTERY_ADDRESS ? `<p style="font-size:10px;">${CONFIG.LOTTERY_ADDRESS}</p>` : '';
            const phoneHtml = CONFIG.LOTTERY_PHONE ? `<p style="font-size:10px;">Tel: ${CONFIG.LOTTERY_PHONE}</p>` : '';

            const content = `
                <html>
                <head>
                    <title>Ticket #${ticket.id}</title>
                </head>
                <body style="font-family:'Courier New', monospace; width:100%; padding:0; margin:0; text-align:center;">
                    ${logoHtml}
                    <h2 style="margin-bottom:5px;">${lotteryName}</h2>
                    ${addressHtml}
                    ${phoneHtml}
                    <p style="font-size:12px; margin:5px 0;">--------------------------</p>
                    <p style="font-size:14px; font-weight:bold;">TIRAJ: ${ticket.drawName.toUpperCase()}</p>
                    <p style="font-size:12px;">TICKET: #${ticket.id}</p>
                    <p style="font-size:12px;">DATE: ${new Date(ticket.date).toLocaleString('fr-FR')}</p>
                    <p style="font-size:12px;">AJAN: ${ticket.agentName}</p>
                    <p style="font-size:12px;">--------------------------</p>
                    <div style="text-align:left; padding:0 10px;">
                        ${betsHtml}
                    </div>
                    <p style="font-size:12px;">--------------------------</p>
                    <h3 style="margin-top:5px;">TOTAL: ${ticket.total} Gdes</h3>
                    <p style="font-size:10px; margin-top:15px;">Mèci paske ou chwazi nou!</p>
                    <p style="font-size:10px;">Bòn Chans!</p>
                    <br><br>
                </body>
                </html>
            `;

            printWindow.document.write(content);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function openAddFundsModal() {
            document.getElementById('funds-overlay').style.display = 'flex';
            document.getElementById('funds-amount').focus();
        }
        
        function closeFundsModal() {
            document.getElementById('funds-overlay').style.display = 'none';
            document.getElementById('funds-amount').value = '';
        }
        
        async function addFunds() {
            const amountInput = document.getElementById('funds-amount');
            const amount = parseFloat(amountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                alert("Tanpri antre yon montan ki valid");
                return;
            }
            
            try {
                // Simuler l'ajout de fonds
                APP_STATE.agentFunds += amount;
                
                // Mettre à jour l'affichage
                document.getElementById('agent-funds').textContent = APP_STATE.agentFunds.toLocaleString() + ' Gdes';
                updateWinnersDisplay();
                
                // Ici vous devriez appeler l'API pour mettre à jour les fonds
                // await APIService.updateAgentFunds(amount);
                
                alert(`${amount.toLocaleString()} Gdes ajoute nan fonds ou!`);
                closeFundsModal();
            } catch (error) {
                console.error('Erreur ajout fonds:', error);
                alert('Erè nan ajout fonds');
            }
        }
        
        function openLotteryConfig() {
            document.getElementById('config-lottery-name').value = CONFIG.LOTTERY_NAME;
            document.getElementById('config-logo-url').value = CONFIG.LOTTERY_LOGO;
            document.getElementById('config-address').value = CONFIG.LOTTERY_ADDRESS;
            document.getElementById('config-phone').value = CONFIG.LOTTERY_PHONE;
            document.getElementById('lottery-config').style.display = 'flex';
        }
        
        function closeLotteryConfig() {
            document.getElementById('lottery-config').style.display = 'none';
        }
        
        function saveLotteryConfig() {
            CONFIG.LOTTERY_NAME = document.getElementById('config-lottery-name').value;
            CONFIG.LOTTERY_LOGO = document.getElementById('config-logo-url').value;
            CONFIG.LOTTERY_ADDRESS = document.getElementById('config-address').value;
            CONFIG.LOTTERY_PHONE = document.getElementById('config-phone').value;
            
            // Mettre à jour l'affichage du nom
            document.getElementById('lottery-name').innerHTML = `${CONFIG.LOTTERY_NAME} <span class="pro-badge">vession 6</span>`;
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('lotteryConfig', JSON.stringify({
                name: CONFIG.LOTTERY_NAME,
                logo: CONFIG.LOTTERY_LOGO,
                address: CONFIG.LOTTERY_ADDRESS,
                phone: CONFIG.LOTTERY_PHONE
            }));
            
            alert("Konfigirasyon sove!");
            closeLotteryConfig();
        }

        function closeWinnerModal() {
            document.getElementById('winner-overlay').style.display = 'none';
        }

        async function initApp() {
            // Charger la configuration du lottery
            const savedConfig = localStorage.getItem('lotteryConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    CONFIG.LOTTERY_NAME = config.name || CONFIG.LOTTERY_NAME;
                    CONFIG.LOTTERY_LOGO = config.logo || CONFIG.LOTTERY_LOGO;
                    CONFIG.LOTTERY_ADDRESS = config.address || CONFIG.LOTTERY_ADDRESS;
                    CONFIG.LOTTERY_PHONE = config.phone || CONFIG.LOTTERY_PHONE;
                    
                    document.getElementById('lottery-name').innerHTML = `${CONFIG.LOTTERY_NAME} <span class="pro-badge">vession 6</span>`;
                } catch (e) {
                    console.error('Erreur chargement configuration:', e);
                }
            }
            
            // Charger l'historique depuis MongoDB
            await APIService.getTickets();
            
            // Charger les tickets gagnants
            await APIService.getWinningTickets();
            
            renderDraws();
            updateClock();
            
            // Vérifier le statut des tirages
            checkSelectedDrawStatus();
            
            console.log("LOTATO PRO Ready - MongoDB Mode");

            setupInputAutoMove();
            
            document.getElementById('add-bet-btn').addEventListener('click', () => CartManager.addBet());
            
            updateGameSelector();
            
            document.getElementById('agent-input').addEventListener('change', function() {
                document.getElementById('agent-name').textContent = this.value;
                APP_STATE.agentId = this.value.toLowerCase().replace(/\s+/g, '-');
            });
            
            document.querySelectorAll('#lotto4-options .option-chip').forEach((chip, index) => {
                chip.querySelector('input').checked = APP_STATE.lotto4Options[index];
            });
            
            document.querySelectorAll('#lotto5-options .option-chip').forEach((chip, index) => {
                chip.querySelector('input').checked = APP_STATE.lotto5Options[index];
            });
            
            // Calculer le profit/pertes initial
            calculateProfitLoss();
        }

        document.addEventListener('DOMContentLoaded', initApp);
        setInterval(updateClock, 1000);
        setInterval(checkSelectedDrawStatus, 30000); // Vérifier toutes les 30 secondes

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('PWA: Service Worker actif'))
                .catch(err => console.error('PWA: Erreur', err));
        }
    </script>
</body>
</html>