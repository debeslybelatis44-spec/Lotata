<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTATO PRO ¬∑ Administration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* M√™me style que responsable.html avec quelques ajouts */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
        body { background:#0a0b1e; color:#fff; padding:20px; }
        .app { max-width:1400px; margin:0 auto; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; background:rgba(255,255,255,0.03); border-radius:20px; padding:20px; }
        .logo h1 { font-size:1.8rem; background:linear-gradient(135deg,#ad00f1,#ff007a); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .logout-btn { background:rgba(255,77,77,0.2); border:1px solid #ff4d4d; color:#ff4d4d; padding:10px 20px; border-radius:30px; cursor:pointer; }
        .section-title { margin:30px 0 20px; font-size:1.4rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; display:flex; align-items:center; gap:10px; }
        .tabs { display:flex; gap:10px; margin-bottom:30px; flex-wrap:wrap; }
        .tab { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:30px; padding:12px 24px; cursor:pointer; }
        .tab.active { background:linear-gradient(135deg,#ad00f1,#00d4ff); color:white; border-color:transparent; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; background:rgba(255,255,255,0.03); border-radius:20px; padding:25px; margin-bottom:20px; }
        .form-group { margin-bottom:15px; }
        .form-group label { display:block; color:#a0a0b8; margin-bottom:6px; font-size:0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:12px 16px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); border-radius:12px; color:white; }
        .btn-primary { background:linear-gradient(135deg,#ad00f1,#00d4ff); border:none; border-radius:30px; padding:12px 30px; color:white; font-weight:600; cursor:pointer; }
        .btn-danger { background:rgba(255,77,77,0.2); border:1px solid #ff4d4d; color:#ff4d4d; border-radius:30px; padding:10px 20px; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:rgba(255,255,255,0.05); border-radius:16px; padding:20px; }
        .list-container { background:rgba(255,255,255,0.02); border-radius:20px; padding:20px; max-height:400px; overflow-y:auto; }
        .item-row { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); }
        .badge-success { background:#00f190; color:black; padding:4px 12px; border-radius:20px; }
        .badge-danger { background:#ff4d4d; color:white; padding:4px 12px; border-radius:20px; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">
                <h1>LOTATO PRO ¬∑ Propri√©taire</h1>
            </div>
            <div class="user-info">
                <span id="owner-name"></span>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
            </div>
        </header>

        <!-- Onglets -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('users')">üë• Utilisateurs</div>
            <div class="tab" onclick="switchTab('draws')">üé≤ Tirages & R√©sultats</div>
            <div class="tab" onclick="switchTab('numbers')">üî¢ Boules & Limites</div>
            <div class="tab" onclick="switchTab('reports')">üìä Rapports</div>
        </div>

        <!-- 1. GESTION UTILISATEURS -->
        <div id="tab-users" class="tab-content active">
            <div class="section-title"><i class="fas fa-user-plus"></i> Cr√©er un utilisateur</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom complet</label>
                    <input type="text" id="create-fullname" placeholder="Jean Dupont">
                </div>
                <div class="form-group">
                    <label>CIN (optionnel)</label>
                    <input type="text" id="create-cin" placeholder="01-02-03-04-05">
                </div>
                <div class="form-group">
                    <label>Identifiant (login)</label>
                    <input type="text" id="create-username" placeholder="jean.dupont">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="create-password" value="default123">
                </div>
                <div class="form-group">
                    <label>R√¥le</label>
                    <select id="create-role">
                        <option value="agent">Agent</option>
                        <option value="supervisor">Superviseur</option>
                    </select>
                </div>
                <div class="form-group" id="supervisor-field">
                    <label>Superviseur (pour agent)</label>
                    <select id="create-supervisor">
                        <option value="">Aucun (agent libre)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Zone / Localisation</label>
                    <input type="text" id="create-zone" placeholder="Port-au-Prince">
                </div>
                <div style="display:flex; align-items:end;">
                    <button class="btn-primary" onclick="createUser()"><i class="fas fa-save"></i> Cr√©er</button>
                </div>
            </div>

            <div class="section-title"><i class="fas fa-list"></i> Agents & Superviseurs</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <h3>Superviseurs</h3>
                    <div id="supervisors-list" class="list-container"></div>
                </div>
                <div>
                    <h3>Agents</h3>
                    <div id="agents-list" class="list-container"></div>
                </div>
            </div>

            <div class="section-title"><i class="fas fa-arrows-spread"></i> Changer superviseur d'un agent</div>
            <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr auto;">
                <select id="change-agent-select"></select>
                <select id="change-supervisor-select"></select>
                <button class="btn-primary" onclick="changeSupervisor()">Transf√©rer</button>
            </div>
        </div>

        <!-- 2. TIRAGES & R√âSULTATS -->
        <div id="tab-draws" class="tab-content">
            <div class="section-title"><i class="fas fa-pen"></i> Publier un r√©sultat</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Tirage</label>
                    <select id="draw-select"></select>
                </div>
                <div class="form-group">
                    <label>1er lot (3 chiffres)</label>
                    <input type="text" id="draw-lot1" maxlength="3" placeholder="465">
                </div>
                <div class="form-group">
                    <label>2e lot (2 chiffres)</label>
                    <input type="text" id="draw-lot2" maxlength="2" placeholder="67">
                </div>
                <div class="form-group">
                    <label>3e lot (2 chiffres)</label>
                    <input type="text" id="draw-lot3" maxlength="2" placeholder="88">
                </div>
                <div style="display:flex; gap:10px; align-items:end;">
                    <button class="btn-primary" onclick="publishManual()">Publier</button>
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Ou URL de r√©sultats</label>
                    <input type="url" id="draw-url" placeholder="https://...">
                </div>
                <div style="display:flex; align-items:end;">
                    <button class="btn-primary" onclick="publishFromUrl()">Importer</button>
                </div>
            </div>

            <div class="section-title"><i class="fas fa-ban"></i> Bloquer / D√©bloquer un tirage</div>
            <div class="form-grid">
                <select id="draw-block-select"></select>
                <button class="btn-danger" onclick="toggleDrawBlock(true)">Bloquer</button>
                <button class="btn-primary" onclick="toggleDrawBlock(false)">D√©bloquer</button>
            </div>
        </div>

        <!-- 3. BOULES & LIMITES -->
        <div id="tab-numbers" class="tab-content">
            <div class="section-title"><i class="fas fa-ban"></i> Bloquer une boule (tous tirages)</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Num√©ro √† bloquer (00-99)</label>
                    <input type="text" id="block-number" maxlength="2" placeholder="82">
                </div>
                <button class="btn-danger" onclick="blockNumber()">Bloquer</button>
                <button class="btn-primary" onclick="unblockNumber()">D√©bloquer</button>
            </div>
            <div id="blocked-numbers-list" class="list-container" style="max-height:150px;"></div>

            <div class="section-title"><i class="fas fa-chart-line"></i> Limiter une boule (montant max)</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Tirage</label>
                    <select id="limit-draw"></select>
                </div>
                <div class="form-group">
                    <label>Num√©ro</label>
                    <input type="text" id="limit-number" maxlength="2" placeholder="48">
                </div>
                <div class="form-group">
                    <label>Montant maximum (G)</label>
                    <input type="number" id="limit-amount" placeholder="100">
                </div>
                <button class="btn-primary" onclick="setNumberLimit()">Appliquer</button>
            </div>
        </div>

        <!-- 4. RAPPORTS -->
        <div id="tab-reports" class="tab-content">
            <div class="section-title"><i class="fas fa-filter"></i> G√©n√©rer rapport</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Superviseur</label>
                    <select id="report-supervisor">
                        <option value="all">Tous</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Agent</label>
                    <select id="report-agent">
                        <option value="all">Tous</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>P√©riode</label>
                    <select id="report-period">
                        <option value="today">Aujourd'hui</option>
                        <option value="yesterday">Hier</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="custom">Personnalis√©e</option>
                    </select>
                </div>
                <div class="form-group" id="custom-dates" style="display:none;">
                    <label>Du</label>
                    <input type="date" id="report-from">
                    <label>Au</label>
                    <input type="date" id="report-to">
                </div>
                <button class="btn-primary" onclick="generateReport()">G√©n√©rer</button>
                <button class="btn-primary" onclick="printReport()"><i class="fas fa-print"></i> Imprimer</button>
            </div>
            <div id="report-result" style="margin-top:30px;"></div>
        </div>

        <script>
            // ---------- INIT AUTH ----------
            (function() {
                const token = localStorage.getItem('auth_token');
                const role = localStorage.getItem('user_role');
                if (!token || role !== 'owner') {
                    window.location.href = 'index.html';
                }
                document.getElementById('owner-name').innerHTML = `<i class="fas fa-crown"></i> ${localStorage.getItem('user_name') || 'Propri√©taire'}`;
            })();

            const API_URL = 'https://lotata-islp.onrender.com/api';

            // ---------- ONGLETS ----------
            function switchTab(tabId) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.tab[onclick*="${tabId}"]`).classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');
                if (tabId === 'users') loadUsersLists();
                if (tabId === 'draws') loadDraws();
                if (tabId === 'numbers') { loadBlockedNumbers(); loadDrawsForLimits(); }
                if (tabId === 'reports') loadSupervisorsForReport();
            }

            // ---------- GESTION UTILISATEURS ----------
            async function loadUsersLists() {
                // superviseurs
                const supRes = await fetch(`${API_URL}/owner/supervisors`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const supervisors = await supRes.json();
                let supHtml = '';
                supervisors.forEach(s => {
                    supHtml += `<div class="item-row">
                        <span><strong>${s.name}</strong> (${s.username})</span>
                        <span class="badge-success">Actif</span>
                    </div>`;
                });
                document.getElementById('supervisors-list').innerHTML = supHtml || '<p>Aucun superviseur</p>';

                // agents
                const agentRes = await fetch(`${API_URL}/owner/agents`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const agents = await agentRes.json();
                let agentHtml = '';
                agents.forEach(a => {
                    agentHtml += `<div class="item-row">
                        <span><strong>${a.name}</strong> (${a.username})</span>
                        <span>Superviseur: ${a.supervisor_name || 'libre'}</span>
                        <button class="btn-danger" style="padding:4px 10px;" onclick="toggleUserBlock('${a.id}','agent')">${a.blocked ? 'D√©bloquer' : 'Bloquer'}</button>
                    </div>`;
                });
                document.getElementById('agents-list').innerHTML = agentHtml;

                // remplir selects pour changement superviseur
                let agentOpts = '<option value="">Choisir agent</option>';
                agents.forEach(a => { agentOpts += `<option value="${a.id}">${a.name}</option>`; });
                document.getElementById('change-agent-select').innerHTML = agentOpts;

                let supOpts = '<option value="">Aucun (libre)</option>';
                supervisors.forEach(s => { supOpts += `<option value="${s.id}">${s.name}</option>`; });
                document.getElementById('change-supervisor-select').innerHTML = supOpts;
                document.getElementById('create-supervisor').innerHTML = supOpts;
            }

            async function createUser() {
                const data = {
                    name: document.getElementById('create-fullname').value,
                    cin: document.getElementById('create-cin').value,
                    username: document.getElementById('create-username').value,
                    password: document.getElementById('create-password').value,
                    role: document.getElementById('create-role').value,
                    supervisorId: document.getElementById('create-supervisor').value || null,
                    zone: document.getElementById('create-zone').value
                };
                if (!data.name || !data.username || !data.password) { alert('Champs requis'); return; }
                try {
                    await fetch(`${API_URL}/owner/create-user`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                        body: JSON.stringify(data)
                    });
                    alert('Utilisateur cr√©√©');
                    loadUsersLists();
                } catch(e) { alert('Erreur'); }
            }

            async function changeSupervisor() {
                const agentId = document.getElementById('change-agent-select').value;
                const supervisorId = document.getElementById('change-supervisor-select').value;
                if (!agentId) return;
                await fetch(`${API_URL}/owner/change-supervisor`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ agentId, supervisorId })
                });
                loadUsersLists();
            }

            async function toggleUserBlock(userId, type) {
                await fetch(`${API_URL}/owner/block-user`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ userId, type })
                });
                loadUsersLists();
            }

            // ---------- TIRAGES ----------
            async function loadDraws() {
                const res = await fetch(`${API_URL}/owner/draws`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const draws = await res.json();
                let opts = '';
                draws.forEach(d => { opts += `<option value="${d.id}">${d.name}</option>`; });
                document.getElementById('draw-select').innerHTML = opts;
                document.getElementById('draw-block-select').innerHTML = opts;
            }

            async function publishManual() {
                const drawId = document.getElementById('draw-select').value;
                const lot1 = document.getElementById('draw-lot1').value;
                const lot2 = document.getElementById('draw-lot2').value;
                const lot3 = document.getElementById('draw-lot3').value;
                if (!drawId || !lot1 || !lot2 || !lot3) return;
                await fetch(`${API_URL}/owner/publish-results`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ drawId, numbers: [lot1, lot2, lot3] })
                });
                alert('R√©sultats publi√©s');
            }

            async function toggleDrawBlock(block) {
                const drawId = document.getElementById('draw-block-select').value;
                await fetch(`${API_URL}/owner/block-draw`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ drawId, block })
                });
                alert(block ? 'Tirage bloqu√©' : 'Tirage d√©bloqu√©');
            }

            // ---------- BOULES ----------
            async function loadBlockedNumbers() {
                const res = await fetch(`${API_URL}/owner/blocked-numbers`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const data = await res.json();
                let html = '<strong>Num√©ros bloqu√©s:</strong> ';
                html += (data.blockedNumbers || []).join(', ') || 'aucun';
                document.getElementById('blocked-numbers-list').innerHTML = html;
            }

            async function blockNumber() {
                const num = document.getElementById('block-number').value.padStart(2,'0');
                await fetch(`${API_URL}/owner/block-number`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ number: num })
                });
                loadBlockedNumbers();
            }

            async function unblockNumber() {
                const num = document.getElementById('block-number').value.padStart(2,'0');
                await fetch(`${API_URL}/owner/unblock-number`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ number: num })
                });
                loadBlockedNumbers();
            }

            async function loadDrawsForLimits() {
                const res = await fetch(`${API_URL}/owner/draws`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const draws = await res.json();
                let opts = '';
                draws.forEach(d => { opts += `<option value="${d.id}">${d.name}</option>`; });
                document.getElementById('limit-draw').innerHTML = opts;
            }

            async function setNumberLimit() {
                const drawId = document.getElementById('limit-draw').value;
                const number = document.getElementById('limit-number').value.padStart(2,'0');
                const amount = parseFloat(document.getElementById('limit-amount').value);
                await fetch(`${API_URL}/owner/number-limit`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ drawId, number, limitAmount: amount })
                });
                alert('Limite appliqu√©e');
            }

            // ---------- RAPPORTS ----------
            async function loadSupervisorsForReport() {
                const res = await fetch(`${API_URL}/owner/supervisors`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const supervisors = await res.json();
                let opts = '<option value="all">Tous superviseurs</option>';
                supervisors.forEach(s => { opts += `<option value="${s.id}">${s.name}</option>`; });
                document.getElementById('report-supervisor').innerHTML = opts;
                // agents
                const agentRes = await fetch(`${API_URL}/owner/agents`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const agents = await agentRes.json();
                let agentOpts = '<option value="all">Tous agents</option>';
                agents.forEach(a => { agentOpts += `<option value="${a.id}">${a.name}</option>`; });
                document.getElementById('report-agent').innerHTML = agentOpts;
            }

            document.getElementById('report-period').addEventListener('change', function(e) {
                document.getElementById('custom-dates').style.display = e.target.value === 'custom' ? 'block' : 'none';
            });

            async function generateReport() {
                const params = new URLSearchParams({
                    supervisorId: document.getElementById('report-supervisor').value,
                    agentId: document.getElementById('report-agent').value,
                    period: document.getElementById('report-period').value,
                    fromDate: document.getElementById('report-from').value,
                    toDate: document.getElementById('report-to').value
                });
                const res = await fetch(`${API_URL}/owner/reports?${params}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                const report = await res.json();
                let html = `<div class="stats-grid">`;
                html += `<div class="stat-card"><div class="stat-value">${report.totalTickets||0}</div><div>Tickets</div></div>`;
                html += `<div class="stat-card"><div class="stat-value">${(report.totalBets||0).toLocaleString()} G</div><div>Pari√©s</div></div>`;
                html += `<div class="stat-card"><div class="stat-value profit">${(report.totalWins||0).toLocaleString()} G</div><div>Gains</div></div>`;
                const balance = (report.totalBets||0) - (report.totalWins||0);
                html += `<div class="stat-card"><div class="stat-value ${balance>=0?'profit':'loss'}">${balance.toLocaleString()} G</div><div>Balance</div></div>`;
                html += `</div>`;
                document.getElementById('report-result').innerHTML = html;
            }

            function printReport() {
                const content = document.getElementById('report-result').innerHTML;
                const w = window.open('', '_blank');
                w.document.write(`<html><head><title>Rapport</title><style>body{font-family:Arial;padding:20px;}</style></head><body>${content}</body></html>`);
                w.document.close();
                w.print();
            }

            function logout() { localStorage.clear(); window.location.href='index.html'; }

            window.onload = function() {
                loadUsersLists();
                loadDraws();
                loadBlockedNumbers();
                loadDrawsForLimits();
                loadSupervisorsForReport();
            };
        </script>
    </div>
</body>
</html>