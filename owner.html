<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTATO PRO ¬∑ Administration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
        body { background:#0a0b1e; color:#fff; padding:20px; }
        .app { max-width:1400px; margin:0 auto; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; background:rgba(255,255,255,0.03); border-radius:20px; padding:20px; }
        .logo h1 { font-size:1.8rem; background:linear-gradient(135deg,#ad00f1,#ff007a); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .logout-btn { background:rgba(255,77,77,0.2); border:1px solid #ff4d4d; color:#ff4d4d; padding:10px 20px; border-radius:30px; cursor:pointer; }
        .section-title { margin:30px 0 20px; font-size:1.4rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; display:flex; align-items:center; gap:10px; }
        .tabs { display:flex; gap:10px; margin-bottom:30px; flex-wrap:wrap; }
        .tab { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:30px; padding:12px 24px; cursor:pointer; transition:0.2s; }
        .tab.active { background:linear-gradient(135deg,#ad00f1,#00d4ff); color:white; border-color:transparent; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; background:rgba(255,255,255,0.03); border-radius:20px; padding:25px; margin-bottom:20px; }
        .form-group { margin-bottom:15px; }
        .form-group label { display:block; color:#a0a0b8; margin-bottom:6px; font-size:0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:12px 16px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); border-radius:12px; color:white; }
        .btn-primary { background:linear-gradient(135deg,#ad00f1,#00d4ff); border:none; border-radius:30px; padding:12px 30px; color:white; font-weight:600; cursor:pointer; }
        .btn-danger { background:rgba(255,77,77,0.2); border:1px solid #ff4d4d; color:#ff4d4d; border-radius:30px; padding:10px 20px; cursor:pointer; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:rgba(255,255,255,0.05); border-radius:16px; padding:20px; }
        .list-container { background:rgba(255,255,255,0.02); border-radius:20px; padding:20px; max-height:400px; overflow-y:auto; }
        .item-row { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); }
        .badge-success { background:#00f190; color:black; padding:4px 12px; border-radius:20px; }
        .badge-danger { background:#ff4d4d; color:white; padding:4px 12px; border-radius:20px; }
        .badge-warning { background:#ffaa00; color:black; padding:4px 12px; border-radius:20px; }
        .chart-container { margin-top:40px; background:rgba(255,255,255,0.02); border-radius:20px; padding:20px; }
        canvas { max-height:300px; }
        .alert { padding:15px; border-radius:12px; margin-bottom:20px; }
        .alert-success { background:rgba(0,241,144,0.2); border:1px solid #00f190; color:#00f190; }
        .alert-danger { background:rgba(255,77,77,0.2); border:1px solid #ff4d4d; color:#ff4d4d; }
        .progress-bar { width:100%; background:rgba(255,255,255,0.1); border-radius:10px; height:8px; margin-top:6px; }
        .progress-fill { height:8px; border-radius:10px; background:linear-gradient(90deg,#ad00f1,#00d4ff); }
        .table-responsive { overflow-x: auto; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:12px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.05); }
        .profit { color:#00f190; }
        .loss { color:#ff4d4d; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo"><h1>LOTATO PRO ¬∑ Propri√©taire</h1></div>
            <div class="user-info">
                <span id="owner-name"></span>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
            </div>
        </header>

        <!-- Onglets -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">üìä Tableau de bord</div>
            <div class="tab" onclick="switchTab('users')">üë• Utilisateurs</div>
            <div class="tab" onclick="switchTab('draws')">üé≤ Tirages & R√©sultats</div>
            <div class="tab" onclick="switchTab('numbers')">üî¢ Boules & Limites</div>
            <div class="tab" onclick="switchTab('reports')">üìä Rapports</div>
        </div>

        <!-- ========== TABLEAU DE BORD ========== -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="section-title"><i class="fas fa-chart-pie"></i> Aper√ßu du jour</div>
            
            <!-- Connexions -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px;">
                <div class="stat-card">
                    <h3><i class="fas fa-user-tie"></i> Superviseurs connect√©s</h3>
                    <div style="font-size:2.5rem;" id="connected-sup-count">0</div>
                    <div id="connected-sup-list" style="margin-top:10px; font-size:0.9rem;"></div>
                </div>
                <div class="stat-card">
                    <h3><i class="fas fa-user"></i> Agents connect√©s</h3>
                    <div style="font-size:2.5rem;" id="connected-agent-count">0</div>
                    <div id="connected-agent-list" style="margin-top:10px; font-size:0.9rem;"></div>
                </div>
            </div>

            <!-- Ventes totales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div style="font-size:2rem;" id="sales-today">0 G</div>
                    <div>Ventes totales (aujourd'hui)</div>
                </div>
            </div>

            <!-- Boules limit√©es et progression -->
            <div class="section-title"><i class="fas fa-chart-line"></i> Progression des limites (aujourd'hui)</div>
            <div class="list-container" id="limits-progress-container" style="max-height:300px;">
                <p>Chargement...</p>
            </div>

            <!-- Agents en gain/perte -->
            <div class="section-title"><i class="fas fa-trophy"></i> Agents avec gains/pertes (aujourd'hui)</div>
            <div class="list-container" id="agents-gainloss-container" style="max-height:300px;">
                <p>Chargement...</p>
            </div>
        </div>

        <!-- ========== GESTION UTILISATEURS ========== -->
        <div id="tab-users" class="tab-content">
            <div class="section-title"><i class="fas fa-user-plus"></i> Cr√©er un utilisateur</div>
            <div id="user-create-message" style="display:none;" class="alert"></div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom complet</label>
                    <input type="text" id="create-fullname" placeholder="Jean Dupont">
                </div>
                <div class="form-group">
                    <label>CIN (optionnel)</label>
                    <input type="text" id="create-cin" placeholder="01-02-03-04-05">
                </div>
                <div class="form-group">
                    <label>Identifiant (login)</label>
                    <input type="text" id="create-username" placeholder="jean.dupont">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="create-password" value="default123">
                </div>
                <div class="form-group">
                    <label>R√¥le</label>
                    <select id="create-role" onchange="toggleSupervisorField()">
                        <option value="agent">Agent</option>
                        <option value="supervisor">Superviseur</option>
                    </select>
                </div>
                <div class="form-group" id="supervisor-field">
                    <label>Superviseur (pour agent)</label>
                    <select id="create-supervisor">
                        <option value="">Aucun (libre)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Zone / Localisation</label>
                    <input type="text" id="create-zone" placeholder="Port-au-Prince">
                </div>
                <div style="display:flex; align-items:end;">
                    <button class="btn-primary" onclick="createUser()"><i class="fas fa-save"></i> Cr√©er</button>
                </div>
            </div>

            <div class="section-title"><i class="fas fa-list"></i> Agents & Superviseurs</div>
            <div id="user-load-error" class="alert alert-danger" style="display:none;"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <h3>Superviseurs</h3>
                    <div id="supervisors-list" class="list-container"></div>
                </div>
                <div>
                    <h3>Agents</h3>
                    <div id="agents-list" class="list-container"></div>
                </div>
            </div>

            <div class="section-title"><i class="fas fa-arrows-spread"></i> Changer superviseur d'un agent</div>
            <div class="form-grid" style="grid-template-columns:1fr 1fr auto;">
                <select id="change-agent-select"></select>
                <select id="change-supervisor-select"></select>
                <button class="btn-primary" onclick="changeSupervisor()">Transf√©rer</button>
            </div>
        </div>

        <!-- ========== TIRAGES & R√âSULTATS ========== -->
        <div id="tab-draws" class="tab-content">
            <div class="section-title"><i class="fas fa-pen"></i> Publier un r√©sultat</div>
            <div id="publish-message" style="display:none;" class="alert"></div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Tirage</label>
                    <select id="draw-select"></select>
                </div>
                <div class="form-group">
                    <label>1er lot (3 chiffres)</label>
                    <input type="text" id="draw-lot1" maxlength="3" placeholder="465">
                </div>
                <div class="form-group">
                    <label>2e lot (2 chiffres)</label>
                    <input type="text" id="draw-lot2" maxlength="2" placeholder="67">
                </div>
                <div class="form-group">
                    <label>3e lot (2 chiffres)</label>
                    <input type="text" id="draw-lot3" maxlength="2" placeholder="88">
                </div>
                <div style="display:flex; gap:10px; align-items:end;">
                    <button class="btn-primary" onclick="publishManual()">Publier</button>
                </div>
            </div>

            <div class="section-title"><i class="fas fa-ban"></i> Bloquer / D√©bloquer un tirage</div>
            <div class="form-grid">
                <select id="draw-block-select"></select>
                <button class="btn-danger" onclick="toggleDrawBlock(true)">Bloquer</button>
                <button class="btn-primary" onclick="toggleDrawBlock(false)">D√©bloquer</button>
            </div>
        </div>

        <!-- ========== BOULES & LIMITES ========== -->
        <div id="tab-numbers" class="tab-content">
            <div class="section-title"><i class="fas fa-ban"></i> Bloquer une boule (tous tirages)</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Num√©ro √† bloquer (00-99)</label>
                    <input type="text" id="block-number" maxlength="2" placeholder="82">
                </div>
                <button class="btn-danger" onclick="blockNumberGlobal()">Bloquer global</button>
                <button class="btn-primary" onclick="unblockNumberGlobal()">D√©bloquer global</button>
            </div>
            <div id="blocked-numbers-list" class="list-container" style="max-height:150px;"></div>

            <div class="section-title"><i class="fas fa-ban"></i> Bloquer une boule pour un tirage sp√©cifique</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Tirage</label>
                    <select id="block-draw-select"></select>
                </div>
                <div class="form-group">
                    <label>Num√©ro √† bloquer</label>
                    <input type="text" id="block-number-draw" maxlength="2" placeholder="48">
                </div>
                <button class="btn-danger" onclick="blockNumberDraw()">Bloquer</button>
                <button class="btn-primary" onclick="unblockNumberDraw()">D√©bloquer</button>
            </div>

            <div class="section-title"><i class="fas fa-chart-line"></i> Limiter une boule (montant max)</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Tirage</label>
                    <select id="limit-draw"></select>
                </div>
                <div class="form-group">
                    <label>Num√©ro</label>
                    <input type="text" id="limit-number" maxlength="2" placeholder="48">
                </div>
                <div class="form-group">
                    <label>Montant maximum (G)</label>
                    <input type="number" id="limit-amount" placeholder="100">
                </div>
                <button class="btn-primary" onclick="setNumberLimit()">Appliquer</button>
            </div>
        </div>

        <!-- ========== RAPPORTS ========== -->
        <div id="tab-reports" class="tab-content">
            <div class="section-title"><i class="fas fa-filter"></i> G√©n√©rer rapport</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Superviseur</label>
                    <select id="report-supervisor"></select>
                </div>
                <div class="form-group">
                    <label>Agent</label>
                    <select id="report-agent"></select>
                </div>
                <div class="form-group">
                    <label>Tirage</label>
                    <select id="report-draw">
                        <option value="all">Tous les tirages</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>P√©riode</label>
                    <select id="report-period" onchange="toggleCustomDates()">
                        <option value="today">Aujourd'hui</option>
                        <option value="yesterday">Hier</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="custom">Personnalis√©e</option>
                    </select>
                </div>
                <div id="custom-dates" style="display:none; grid-column:span 2; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="form-group">
                        <label>Du</label>
                        <input type="date" id="report-from">
                    </div>
                    <div class="form-group">
                        <label>Au</label>
                        <input type="date" id="report-to">
                    </div>
                </div>
                <div class="form-group">
                    <label>Filtre gain/perte</label>
                    <select id="report-gainloss">
                        <option value="">Tous</option>
                        <option value="gain">Gain (gagnant)</option>
                        <option value="loss">Perte (perdant)</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="generateReport()">G√©n√©rer</button>
                <button class="btn-primary" onclick="printReport()"><i class="fas fa-print"></i> Imprimer</button>
            </div>
            <div id="report-result" style="margin-top:30px;"></div>
            <div class="chart-container" id="report-chart-container" style="display:none;">
                <canvas id="reportChart"></canvas>
            </div>
        </div>

        <script>
            // ---------- CONFIGURATION ----------
            const API_URL = ''; // Laissez vide si m√™me origine, sinon 'https://votre-backend.com/api'
            let chartInstance = null;

            // ---------- AUTH ----------
            (function() {
                const token = localStorage.getItem('auth_token');
                const role = localStorage.getItem('user_role');
                if (!token || role !== 'owner') {
                    window.location.href = 'index.html';
                }
                document.getElementById('owner-name').innerHTML = `<i class="fas fa-crown"></i> ${localStorage.getItem('user_name') || 'Propri√©taire'}`;
            })();

            // ---------- ONGLETS ----------
            function switchTab(tabId) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.tab[onclick*="${tabId}"]`).classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');
                
                // Charger les donn√©es selon l'onglet
                if (tabId === 'dashboard') loadDashboard();
                if (tabId === 'users') loadUsersLists();
                if (tabId === 'draws') loadDraws();
                if (tabId === 'numbers') { loadBlockedNumbers(); loadDrawsForSelects(); }
                if (tabId === 'reports') { loadSupervisorsAndAgents(); loadDrawsForReport(); }
            }

            // ---------- UTILITAIRES ----------
            function showMessage(elementId, message, isSuccess = true) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.style.display = 'block';
                    el.className = isSuccess ? 'alert alert-success' : 'alert alert-danger';
                    el.innerHTML = message;
                    setTimeout(() => { el.style.display = 'none'; }, 5000);
                }
            }

            // ---------- TABLEAU DE BORD ----------
            async function loadDashboard() {
                const token = localStorage.getItem('auth_token');
                try {
                    const res = await fetch(`${API_URL}/api/owner/dashboard`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error('Erreur chargement dashboard');
                    const data = await res.json();

                    // Connexions
                    document.getElementById('connected-sup-count').innerText = data.connected.supervisors_count;
                    document.getElementById('connected-agent-count').innerText = data.connected.agents_count;
                    
                    let supList = '';
                    data.connected.supervisors.forEach(s => supList += `<div>üë§ ${s.name} (${s.username})</div>`);
                    document.getElementById('connected-sup-list').innerHTML = supList || '<span style="opacity:0.7;">Aucun superviseur connect√©</span>';
                    
                    let agentList = '';
                    data.connected.agents.forEach(a => agentList += `<div>üë§ ${a.name} (${a.username})</div>`);
                    document.getElementById('connected-agent-list').innerHTML = agentList || '<span style="opacity:0.7;">Aucun agent connect√©</span>';

                    // Ventes
                    document.getElementById('sales-today').innerHTML = `${data.sales_today.toLocaleString()} G`;

                    // Progression des limites
                    let limitsHtml = '';
                    if (data.limits_progress.length === 0) {
                        limitsHtml = '<p>Aucune limite d√©finie</p>';
                    } else {
                        limitsHtml = '<table><thead><tr><th>Tirage</th><th>Num√©ro</th><th>Limite</th><th>Mis√©</th><th>%</th></tr></thead><tbody>';
                        data.limits_progress.forEach(l => {
                            const percent = l.progress_percent.toFixed(1);
                            let statusClass = '';
                            if (percent >= 90) statusClass = 'badge-danger';
                            else if (percent >= 70) statusClass = 'badge-warning';
                            else statusClass = 'badge-success';
                            limitsHtml += `<tr>
                                <td>${l.draw_name}</td>
                                <td>${l.number}</td>
                                <td>${l.limit_amount.toLocaleString()} G</td>
                                <td>${l.current_bets.toLocaleString()} G</td>
                                <td><span class="${statusClass}">${percent}%</span></td>
                            </tr>`;
                        });
                        limitsHtml += '</tbody></table>';
                    }
                    document.getElementById('limits-progress-container').innerHTML = limitsHtml;

                    // Agents gains/pertes
                    let agentsHtml = '';
                    if (data.agents_gain_loss.length === 0) {
                        agentsHtml = '<p>Aucun agent avec gain/perte aujourd\'hui</p>';
                    } else {
                        agentsHtml = '<table><thead><tr><th>Agent</th><th>Mises</th><th>Gains</th><th>R√©sultat net</th></tr></thead><tbody>';
                        data.agents_gain_loss.forEach(a => {
                            const netClass = a.net_result >= 0 ? 'profit' : 'loss';
                            agentsHtml += `<tr>
                                <td>${a.name}</td>
                                <td>${a.total_bets.toLocaleString()} G</td>
                                <td>${a.total_wins.toLocaleString()} G</td>
                                <td class="${netClass}">${a.net_result.toLocaleString()} G</td>
                            </tr>`;
                        });
                        agentsHtml += '</tbody></table>';
                    }
                    document.getElementById('agents-gainloss-container').innerHTML = agentsHtml;

                } catch (e) {
                    console.error('Dashboard error:', e);
                    showMessage('', 'Erreur chargement dashboard', false);
                }
            }

            // ---------- GESTION UTILISATEURS ----------
            async function loadUsersLists() {
                const token = localStorage.getItem('auth_token');
                try {
                    // Superviseurs
                    const supRes = await fetch(`${API_URL}/api/owner/supervisors`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!supRes.ok) throw new Error('Erreur chargement superviseurs');
                    const supervisors = await supRes.json();
                    let supHtml = '';
                    supervisors.forEach(s => {
                        supHtml += `<div class="item-row">
                            <span><strong>${s.name}</strong> (${s.username})</span>
                            <span class="${s.blocked ? 'badge-danger' : 'badge-success'}">${s.blocked ? 'Bloqu√©' : 'Actif'}</span>
                            <button class="btn-danger" style="padding:4px 10px;" onclick="toggleUserBlock('${s.id}','supervisor')">${s.blocked ? 'D√©bloquer' : 'Bloquer'}</button>
                        </div>`;
                    });
                    document.getElementById('supervisors-list').innerHTML = supHtml || '<p>Aucun superviseur</p>';

                    // Agents
                    const agentRes = await fetch(`${API_URL}/api/owner/agents`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!agentRes.ok) throw new Error('Erreur chargement agents');
                    const agents = await agentRes.json();
                    let agentHtml = '';
                    agents.forEach(a => {
                        agentHtml += `<div class="item-row">
                            <span><strong>${a.name}</strong> (${a.username})</span>
                            <span>Superviseur: ${a.supervisor_name || 'libre'}</span>
                            <span class="${a.blocked ? 'badge-danger' : 'badge-success'}">${a.blocked ? 'Bloqu√©' : 'Actif'}</span>
                            <button class="btn-danger" style="padding:4px 10px;" onclick="toggleUserBlock('${a.id}','agent')">${a.blocked ? 'D√©bloquer' : 'Bloquer'}</button>
                        </div>`;
                    });
                    document.getElementById('agents-list').innerHTML = agentHtml || '<p>Aucun agent</p>';

                    // Remplir les selects de superviseurs (pour cr√©ation et transfert)
                    let supOpts = '<option value="">Aucun (libre)</option>';
                    supervisors.forEach(s => { supOpts += `<option value="${s.id}">${s.name}</option>`; });
                    document.getElementById('create-supervisor').innerHTML = supOpts;
                    document.getElementById('change-supervisor-select').innerHTML = supOpts;

                    // Remplir le select des agents pour le transfert
                    let agentOpts = '<option value="">Choisir agent</option>';
                    agents.forEach(a => { agentOpts += `<option value="${a.id}">${a.name}</option>`; });
                    document.getElementById('change-agent-select').innerHTML = agentOpts;

                } catch (e) {
                    console.error(e);
                    document.getElementById('user-load-error').style.display = 'block';
                    document.getElementById('user-load-error').innerText = 'Erreur chargement des utilisateurs : ' + e.message;
                }
            }

            function toggleSupervisorField() {
                const role = document.getElementById('create-role').value;
                document.getElementById('supervisor-field').style.display = role === 'agent' ? 'block' : 'none';
            }

            async function createUser() {
                const token = localStorage.getItem('auth_token');
                const data = {
                    name: document.getElementById('create-fullname').value,
                    cin: document.getElementById('create-cin').value,
                    username: document.getElementById('create-username').value,
                    password: document.getElementById('create-password').value,
                    role: document.getElementById('create-role').value,
                    supervisorId: document.getElementById('create-supervisor').value || null,
                    zone: document.getElementById('create-zone').value
                };
                if (!data.name || !data.username || !data.password) {
                    showMessage('user-create-message', 'Veuillez remplir tous les champs obligatoires', false);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/api/owner/create-user`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await res.json();
                    if (result.success) {
                        showMessage('user-create-message', '‚úÖ Utilisateur cr√©√© avec succ√®s', true);
                        loadUsersLists();
                        document.getElementById('create-fullname').value = '';
                        document.getElementById('create-cin').value = '';
                        document.getElementById('create-username').value = '';
                        document.getElementById('create-password').value = 'default123';
                        document.getElementById('create-zone').value = '';
                    } else {
                        showMessage('user-create-message', '‚ùå ' + (result.error || 'Erreur'), false);
                    }
                } catch (e) {
                    showMessage('user-create-message', '‚ùå Erreur r√©seau', false);
                }
            }

            async function toggleUserBlock(userId, type) {
                const token = localStorage.getItem('auth_token');
                await fetch(`${API_URL}/api/owner/block-user`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, type })
                });
                loadUsersLists();
            }

            async function changeSupervisor() {
                const token = localStorage.getItem('auth_token');
                const agentId = document.getElementById('change-agent-select').value;
                const supervisorId = document.getElementById('change-supervisor-select').value;
                if (!agentId) return;
                await fetch(`${API_URL}/api/owner/change-supervisor`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agentId, supervisorId: supervisorId || null })
                });
                loadUsersLists();
            }

            // ---------- TIRAGES ----------
            async function loadDraws() {
                const token = localStorage.getItem('auth_token');
                try {
                    const res = await fetch(`${API_URL}/api/owner/draws`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const draws = await res.json();
                    let opts = '<option value="">S√©lectionnez un tirage</option>';
                    draws.forEach(d => { opts += `<option value="${d.id}">${d.name} (${d.time})</option>`; });
                    document.getElementById('draw-select').innerHTML = opts;
                    document.getElementById('draw-block-select').innerHTML = opts;
                } catch (e) { console.error(e); }
            }

            async function publishManual() {
                const token = localStorage.getItem('auth_token');
                const drawId = document.getElementById('draw-select').value;
                const lot1 = document.getElementById('draw-lot1').value.padStart(3, '0');
                const lot2 = document.getElementById('draw-lot2').value.padStart(2, '0');
                const lot3 = document.getElementById('draw-lot3').value.padStart(2, '0');
                if (!drawId || !lot1 || !lot2 || !lot3) {
                    showMessage('publish-message', 'Veuillez remplir tous les lots', false);
                    return;
                }
                try {
                    const res = await fetch(`${API_URL}/api/owner/publish-results`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ drawId, numbers: [lot1, lot2, lot3] })
                    });
                    const result = await res.json();
                    showMessage('publish-message', result.success ? '‚úÖ R√©sultats publi√©s' : '‚ùå Erreur', result.success);
                } catch (e) { showMessage('publish-message', '‚ùå Erreur', false); }
            }

            async function toggleDrawBlock(block) {
                const token = localStorage.getItem('auth_token');
                const drawId = document.getElementById('draw-block-select').value;
                if (!drawId) return;
                await fetch(`${API_URL}/api/owner/block-draw`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drawId, block })
                });
                alert(block ? 'Tirage bloqu√©' : 'Tirage d√©bloqu√©');
                loadDraws();
            }

            // ---------- BOULES & LIMITES ----------
            async function loadDrawsForSelects() {
                const token = localStorage.getItem('auth_token');
                const res = await fetch(`${API_URL}/api/owner/draws`, { headers: { 'Authorization': `Bearer ${token}` } });
                const draws = await res.json();
                let opts = '<option value="">S√©lectionnez un tirage</option>';
                draws.forEach(d => { opts += `<option value="${d.id}">${d.name}</option>`; });
                document.getElementById('limit-draw').innerHTML = opts;
                document.getElementById('block-draw-select').innerHTML = opts;
            }

            async function loadBlockedNumbers() {
                const token = localStorage.getItem('auth_token');
                const res = await fetch(`${API_URL}/api/owner/blocked-numbers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                let html = '<strong>Num√©ros bloqu√©s globalement:</strong> ';
                html += (data.blockedNumbers || []).join(', ') || 'aucun';
                document.getElementById('blocked-numbers-list').innerHTML = html;
            }

            async function blockNumberGlobal() {
                const token = localStorage.getItem('auth_token');
                const num = document.getElementById('block-number').value.padStart(2, '0');
                if (!num) return;
                await fetch(`${API_URL}/api/owner/block-number`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number: num })
                });
                loadBlockedNumbers();
            }
            async function unblockNumberGlobal() {
                const token = localStorage.getItem('auth_token');
                const num = document.getElementById('block-number').value.padStart(2, '0');
                await fetch(`${API_URL}/api/owner/unblock-number`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number: num })
                });
                loadBlockedNumbers();
            }

            async function blockNumberDraw() {
                const token = localStorage.getItem('auth_token');
                const drawId = document.getElementById('block-draw-select').value;
                const num = document.getElementById('block-number-draw').value.padStart(2, '0');
                if (!drawId || !num) { alert('Choisissez un tirage et un num√©ro'); return; }
                await fetch(`${API_URL}/api/owner/block-number-draw`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drawId, number: num })
                });
                alert('Num√©ro bloqu√© pour ce tirage');
            }
            async function unblockNumberDraw() {
                const token = localStorage.getItem('auth_token');
                const drawId = document.getElementById('block-draw-select').value;
                const num = document.getElementById('block-number-draw').value.padStart(2, '0');
                await fetch(`${API_URL}/api/owner/unblock-number-draw`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drawId, number: num })
                });
                alert('Num√©ro d√©bloqu√© pour ce tirage');
            }

            async function setNumberLimit() {
                const token = localStorage.getItem('auth_token');
                const drawId = document.getElementById('limit-draw').value;
                const number = document.getElementById('limit-number').value.padStart(2, '0');
                const amount = parseFloat(document.getElementById('limit-amount').value);
                if (!drawId || !number || !amount) { alert('Veuillez remplir tous les champs'); return; }
                await fetch(`${API_URL}/api/owner/number-limit`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drawId, number, limitAmount: amount })
                });
                alert('Limite appliqu√©e');
            }

            // ---------- RAPPORTS ----------
            async function loadSupervisorsAndAgents() {
                const token = localStorage.getItem('auth_token');
                // Superviseurs
                const supRes = await fetch(`${API_URL}/api/owner/supervisors`, { headers: { 'Authorization': `Bearer ${token}` } });
                const supervisors = await supRes.json();
                let supOpts = '<option value="all">Tous superviseurs</option>';
                supervisors.forEach(s => supOpts += `<option value="${s.id}">${s.name}</option>`);
                document.getElementById('report-supervisor').innerHTML = supOpts;
                // Agents
                const agentRes = await fetch(`${API_URL}/api/owner/agents`, { headers: { 'Authorization': `Bearer ${token}` } });
                const agents = await agentRes.json();
                let agentOpts = '<option value="all">Tous agents</option>';
                agents.forEach(a => agentOpts += `<option value="${a.id}">${a.name}</option>`);
                document.getElementById('report-agent').innerHTML = agentOpts;
            }

            async function loadDrawsForReport() {
                const token = localStorage.getItem('auth_token');
                const res = await fetch(`${API_URL}/api/owner/draws`, { headers: { 'Authorization': `Bearer ${token}` } });
                const draws = await res.json();
                let opts = '<option value="all">Tous les tirages</option>';
                draws.forEach(d => opts += `<option value="${d.id}">${d.name}</option>`);
                document.getElementById('report-draw').innerHTML = opts;
            }

            function toggleCustomDates() {
                const period = document.getElementById('report-period').value;
                document.getElementById('custom-dates').style.display = period === 'custom' ? 'grid' : 'none';
            }

            async function generateReport() {
                const token = localStorage.getItem('auth_token');
                const params = new URLSearchParams({
                    supervisorId: document.getElementById('report-supervisor').value,
                    agentId: document.getElementById('report-agent').value,
                    drawId: document.getElementById('report-draw').value,
                    period: document.getElementById('report-period').value,
                    fromDate: document.getElementById('report-from').value,
                    toDate: document.getElementById('report-to').value,
                    gainLoss: document.getElementById('report-gainloss').value
                });

                const res = await fetch(`${API_URL}/api/owner/reports?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const report = await res.json();
                displayReport(report);
            }

            function displayReport(report) {
                const s = report.summary;
                let html = `<div class="stats-grid">`;
                html += `<div class="stat-card"><div style="font-size:2rem;">${s.totalTickets}</div><div>Tickets</div></div>`;
                html += `<div class="stat-card"><div style="font-size:2rem;">${s.totalBets.toLocaleString()} G</div><div>Pari√©s</div></div>`;
                html += `<div class="stat-card"><div style="font-size:2rem;">${s.totalWins.toLocaleString()} G</div><div>Gains</div></div>`;
                html += `<div class="stat-card"><div style="font-size:2rem;" class="${s.netResult >= 0 ? 'profit' : 'loss'}">${s.netResult.toLocaleString()} G</div><div>R√©sultat net</div></div>`;
                html += `<div class="stat-card"><div style="font-size:2rem;">${s.gainCount}</div><div>Agents en gain</div></div>`;
                html += `<div class="stat-card"><div style="font-size:2rem;">${s.lossCount}</div><div>Agents en perte</div></div>`;
                html += `</div>`;

                if (report.detail && report.detail.length > 0) {
                    html += `<h3>D√©tail</h3><div class="list-container">`;
                    html += `<table><thead><tr><th>Nom</th><th>Tickets</th><th>Mises</th><th>Gains</th><th>R√©sultat</th></tr></thead><tbody>`;
                    report.detail.forEach(d => {
                        const result = parseFloat(d.result || d.wins - d.bets);
                        html += `<tr>
                            <td>${d.draw_name || d.agent_name || d.draw_id || d.agent_id}</td>
                            <td>${d.tickets}</td>
                            <td>${parseFloat(d.bets).toLocaleString()} G</td>
                            <td>${parseFloat(d.wins).toLocaleString()} G</td>
                            <td style="color:${result >= 0 ? '#00f190' : '#ff4d4d'};">${result.toLocaleString()} G</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }
                document.getElementById('report-result').innerHTML = html;

                // Graphique
                const ctx = document.getElementById('reportChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Mises', 'Gains', 'R√©sultat net'],
                        datasets: [{
                            label: 'Montants (G)',
                            data: [s.totalBets, s.totalWins, s.netResult],
                            backgroundColor: ['#00d4ff', '#00f190', '#ad00f1']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } } },
                        plugins: { legend: { labels: { color: 'white' } } }
                    }
                });
                document.getElementById('report-chart-container').style.display = 'block';
            }

            function printReport() {
                const content = document.getElementById('report-result').innerHTML;
                const w = window.open('', '_blank');
                w.document.write(`<html><head><title>Rapport LOTATO</title><style>body{font-family:Arial;padding:20px;background:#0a0b1e;color:#fff;}</style></head><body>${content}</body></html>`);
                w.document.close();
                w.print();
            }

            // ---------- D√âCONNEXION ----------
            function logout() { localStorage.clear(); window.location.href = 'index.html'; }

            // ---------- CHARGEMENT INITIAL ----------
            window.onload = function() {
                loadDashboard(); // onglet dashboard par d√©faut
                loadUsersLists();
                loadDraws();
                loadBlockedNumbers();
                loadDrawsForSelects();
                loadSupervisorsAndAgents();
                loadDrawsForReport();
                toggleSupervisorField();
                toggleCustomDates();
            };
        </script>
    </div>
</body>
</html>